<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <title>NACM // SUBJECT CONSOLE</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <style>
        :root {
            --bg: #02040a;
            --fg: #f5f7ff;
            --accent: #00eaf2;
            --accent-soft: rgba(0, 234, 242, .16);
            --card: #070b14;
            --border: rgba(255, 255, 255, .06);
            --muted: #8f9ab4;
            --danger: #ff4b6a;
            --warn: #ffb74b;
            --ok: #53ffa8;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        html,
        body {
            height: 100%
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background:
                radial-gradient(circle at 0 0, rgba(0, 234, 242, .12), transparent 55%),
                radial-gradient(circle at 100% 100%, rgba(137, 76, 255, .18), transparent 55%),
                #02040a;
            color: var(--fg);
            overflow: hidden;
        }

        a {
            color: var(--accent);
            text-decoration: none
        }

        a:hover {
            text-decoration: underline
        }

        button,
        input,
        select {
            font: inherit
        }

        /* HEADER */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 14px;
            background: linear-gradient(90deg, rgba(0, 0, 0, .9), rgba(0, 0, 0, .75));
            border-bottom: 1px solid rgba(255, 255, 255, .1);
            z-index: 10;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            letter-spacing: .14em;
            text-transform: uppercase;
            color: var(--muted);
        }

        .brand span {
            font-weight: 600;
            color: var(--accent);
        }

        .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .3);
            text-transform: uppercase;
            letter-spacing: .16em;
            color: var(--muted);
        }

        main {
            position: absolute;
            inset: 34px 0 0 0;
            display: flex;
            align-items: stretch;
            justify-content: center;
            padding: 16px;
        }

        .shell {
            width: 100%;
            max-width: 1120px;
            height: 100%;
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, .2);
            background:
                radial-gradient(circle at 0 0, rgba(0, 234, 242, .22), transparent 55%),
                linear-gradient(135deg, rgba(5, 10, 24, .98), rgba(3, 6, 14, .98));
            box-shadow:
                0 20px 40px rgba(0, 0, 0, .7),
                0 0 0 1px rgba(255, 255, 255, .06) inset;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }

        .shell-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--muted);
        }

        .crumbs {
            text-transform: uppercase;
            letter-spacing: .18em;
            font-size: 11px;
        }

        .crumbs span {
            color: var(--accent);
        }

        .chip-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .chip {
            padding: 3px 7px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .1);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: .12em;
            color: var(--muted);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .chip b {
            color: var(--accent);
            font-weight: 600
        }

        .chip.danger {
            border-color: rgba(255, 75, 106, .7);
            color: var(--danger)
        }

        .chip.danger b {
            color: var(--danger)
        }

        .chip.ok {
            border-color: rgba(83, 255, 168, .7);
            color: var(--ok)
        }

        .chip.ok b {
            color: var(--ok)
        }

        section {
            flex: 1;
            display: flex;
            gap: 12px;
            overflow: hidden;
        }

        .panel {
            background: radial-gradient(circle at 0 0, rgba(255, 255, 255, .03), transparent 55%), #040713;
            border-radius: 14px;
            border: 1px solid var(--border);
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .panel h2,
        .panel h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: .18em;
            color: var(--muted);
        }

        .leftcol {
            flex: 0 0 40%;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 0;
        }

        .rightcol {
            flex: 0 0 60%;
            min-width: 0;
        }

        /* LOGIN PANEL */
        #login {
            flex: 1;
            align-items: center;
            justify-content: center;
        }

        .login-inner {
            max-width: 360px;
            margin: 0 auto;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .login-title {
            font-size: 17px;
            text-transform: uppercase;
            letter-spacing: .18em;
            color: var(--muted);
        }

        .login-title span {
            color: var(--accent);
            font-weight: 600;
        }

        .kv {
            display: grid;
            grid-template-columns: auto 1fr;
            column-gap: 12px;
            row-gap: 4px;
            font-size: 12px;
            align-items: center;
        }

        .kv b {
            font-weight: 500;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .12em;
            font-size: 10px;
        }

        .kv input {
            border-radius: 999px;
            border: 1px solid var(--border);
            padding: 4px 8px;
            background: #03040a;
            color: var(--fg);
        }

        .btn {
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .28);
            background: linear-gradient(135deg, rgba(0, 234, 242, .18), rgba(0, 234, 242, .02));
            color: var(--fg);
            font-size: 11px;
            letter-spacing: .14em;
            text-transform: uppercase;
            padding: 6px 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(0, 234, 242, .3);
        }

        .btn.small {
            padding: 4px 10px;
            font-size: 10px
        }

        .muted {
            color: var(--muted);
            font-size: 11px
        }

        .hidden {
            display: none !important
        }

        .more-btn {
            padding-inline: 8px;
            font-size: 9px;
        }


        /* SUBJECT TABLE */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        th,
        td {
            padding: 6px 4px;
            border-bottom: 1px dashed rgba(255, 255, 255, .06);
            text-align: left;
        }

        th {
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: .12em;
            color: var(--muted);
            font-size: 10px;
        }

        tbody tr {
            cursor: pointer;
            transition: background .14s ease, border-color .14s ease;
        }

        tbody tr:hover {
            background: rgba(0, 234, 242, .07);
            border-color: rgba(0, 234, 242, .4);
        }

        tbody tr td:first-child strong {
            font-size: 12px;
        }

        .statusDot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 999px;
            margin-right: 4px;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, .8);
        }

        .s-green {
            background: var(--ok)
        }

        .s-yellow {
            background: var(--warn)
        }

        .s-red {
            background: var(--danger)
        }

        .s-gray {
            background: #777
        }

        /* DOSSIER + MAP HUD */
        .dossier {
            display: flex;
            flex-direction: column;
            gap: 8px;
            height: 100%;
        }

        /* üîΩ DETAIL PROFILE Ïä§ÌÅ¨Î°§ Ï≤òÎ¶¨ */
        #subjectDetail {
            max-height: min(220px, 28vh);
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 4px;
        }

        /* üîΩ DETAIL PROFILE Ïä§ÌÅ¨Î°§Î∞î Ïä§ÌÉÄÏùº */
        #subjectDetail::-webkit-scrollbar {
            width: 6px;
        }

        #subjectDetail::-webkit-scrollbar-thumb {
            background: rgba(0, 234, 242, .35);
            border-radius: 4px;
        }

        #subjectDetail::-webkit-scrollbar-track {
            background: transparent;
        }

        .dossier h3 {
            margin-bottom: 2px;
        }

        #subjectInfo {
            font-size: 11px;
            padding: 6px 8px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, .08);
            background: rgba(0, 0, 0, .25);
        }

        .dossier .map-inner {
            position: relative;
            margin-top: 6px;
            display: grid;
            grid-template-columns: 1fr;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, .06);
            background: #05070b;
            min-height: 240px;
            flex: 1 1 auto;
        }

        .dossier .city {
            position: relative;
            overflow: hidden;
            min-height: 100%;
            --camX: 0px;
            --camY: 0px;
            --bgx: 0px;
            --bgy: 0px;
        }

        .dossier .cityContent {
            position: absolute;
            inset: 0;
            transform: translate(var(--camX), var(--camY));
            will-change: transform;
        }

        .dossier .city::before {
            content: "";
            position: absolute;
            inset: 0;
            background:
                linear-gradient(90deg, rgba(0, 245, 255, .12) 1px, transparent 1px) var(--bgx) var(--bgy)/32px 32px,
                linear-gradient(0deg, rgba(0, 245, 255, .12) 1px, transparent 1px) var(--bgx) var(--bgy)/32px 32px,
                radial-gradient(circle at 40% 60%, rgba(0, 245, 255, .06), transparent 40%),
                radial-gradient(circle at 70% 30%, rgba(0, 245, 255, .05), transparent 40%),
                linear-gradient(180deg, #071018 0%, #060b12 60%, #05080e 100%);
            filter: contrast(120%);
        }

        .dossier .datastream {
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(90deg,
                    rgba(0, 245, 255, .05) 0 2px,
                    transparent 2px 6px);
            background-size: 200% 100%;
            animation: flow 6s linear infinite;
            mix-blend-mode: screen;
            pointer-events: none;
        }

        .dossier .radar {
            position: absolute;
            inset: -30%;
            background: conic-gradient(from var(--a), rgba(0, 245, 255, .22), transparent 35%);
            mix-blend-mode: screen;
            filter: blur(10px);
            animation: radar 7s linear infinite;
        }

        .dossier .rightHud {
            border-left: 1px solid rgba(255, 255, 255, .06);
            background: linear-gradient(180deg, rgba(255, 255, 255, .02), transparent);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: hidden;
        }

        .dossier .rightHud h3 {
            font-size: 11px;
            letter-spacing: .16em;
            color: var(--muted);
            text-transform: uppercase;
        }

        .dossier .streamBox {
            height: 100px;
            border: 1px solid rgba(255, 255, 255, .06);
            border-radius: 10px;
            position: relative;
            background: rgba(0, 0, 0, .3);
            overflow: hidden;
        }

        .dossier #wave {
            position: absolute;
            inset: 0;
        }

        .dossier .streamGlow {
            position: absolute;
            inset: 0;
            background: radial-gradient(600px 240px at 20% 40%, rgba(0, 245, 255, .12), transparent 60%);
            mix-blend-mode: screen;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            font-size: 11px;
        }

        .hud {
            font-size: 11px;
            color: #8fa0b6;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, .06);
            padding: 6px 8px;
            min-height: 38px;
        }

        .logs {
            margin-top: 6px;
            height: 120px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 11px;
            flex: 0 0 auto;
        }

        .log {
            font-family: ui-monospace, Consolas, monospace;
            font-size: 11px;
            color: #8fd9ef;
            background: rgba(0, 0, 0, .35);
            border: 1px solid rgba(255, 255, 255, .06);
            border-radius: 8px;
            padding: 4px 6px;
        }

        /* === Îßµ ÏúÑ Î∏îÎ¶Ω + ÎØ∏Îãà Ïπ¥Îìú (index2 Ïä§ÌÉÄÏùº) === */
        /* <<< Ï∂îÍ∞Ä */
        .dossier .blip {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            pointer-events: auto;
        }

        .dossier .blip .p {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 10px var(--accent), 0 0 18px rgba(0, 245, 255, .45);
        }

        .dossier .blip.monitoring .p {
            background: var(--ok);
            box-shadow: 0 0 10px var(--ok), 0 0 18px rgba(83, 255, 168, .45);
        }

        .dossier .blip.missing .p {
            background: var(--danger);
            box-shadow: 0 0 10px var(--danger), 0 0 20px rgba(255, 75, 106, .5);
        }

        .dossier .blip.unknown .p {
            background: #8892a0;
            box-shadow: 0 0 8px #8892a0, 0 0 14px rgba(136, 146, 160, .4);
        }

        .mini {
            /* Í≥†Ï†ï ÏúÑÏπò ÏûëÏùÄ Ï†ïÎ≥¥Ï∞Ω */
            /* <<< Ï∂îÍ∞Ä */
            position: fixed;
            min-width: 180px;
            max-width: 240px;
            background: rgba(4, 8, 12, .94);
            border: 1px solid rgba(0, 245, 255, .3);
            box-shadow: 0 14px 28px rgba(0, 0, 0, .7);
            border-radius: 10px;
            padding: 8px 10px;
            font-size: 11px;
            color: #a9e9ff;
            z-index: 50;
        }

        .mini h4 {
            margin: 0 0 4px;
            color: #bffaff;
            font-size: 11px;
        }

        .mini small {
            color: var(--muted);
            display: block;
            margin-top: 2px;
        }

        /* TOAST */
        .toast {
            position: fixed;
            left: 50%;
            bottom: 18px;
            transform: translateX(-50%) translateY(100%);
            padding: 6px 14px;
            border-radius: 999px;
            border: 1px solid rgba(0, 234, 242, .7);
            background: rgba(2, 8, 18, .96);
            font-size: 11px;
            letter-spacing: .12em;
            text-transform: uppercase;
            color: var(--accent);
            opacity: 0;
            pointer-events: none;
            transition: transform .25s ease, opacity .25s ease;
            z-index: 40;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        @keyframes flow {
            to {
                background-position: -200% 0
            }
        }

        @keyframes radar {
            to {
                transform: rotate(360deg)
            }
        }

        @media (max-width:900px) {
            main {
                padding: 8px;
                position: static;
                /* ‚Üê Ï∂îÍ∞Ä */
                inset: auto;
                /* ‚Üê Ï∂îÍ∞Ä */
                height: auto;
                /* ‚Üê Ï∂îÍ∞Ä */
            }


            .shell {
                padding: 10px;
                height: auto;
                /* ‚Üê Ï∂îÍ∞Ä */
            }

            section {
                flex-direction: column;
                overflow: visible;
                /* ‚Üê Ï∂îÍ∞Ä */
            }

            .leftcol,
            .rightcol {
                flex: none;
                /* ‚Üê Í∏∞Ï°¥ flex:1 Ï†úÍ±∞ Ï∂îÏ≤ú */
                width: 100%;
                /* ‚Üê Î™®Î∞îÏùºÏö©ÏúºÎ°ú ÌôïÏû• */
            }

            body {
                overflow: auto
            }
        }

        /* ============================================================
    MOBILE OPTIMIZATION PATCH // NACM CONSOLE (Ïó∞Ï†ú Ï†úÏûë)
    ÌôîÎ©¥Ìè≠ 768px Ïù¥Ìïò ‚Üí Î™®Î∞îÏùº Ï†ÑÏö© UI
============================================================ */
        @media (max-width: 768px) {

            /* Ï†ÑÏ≤¥ Ïä§ÌÅ¨Î°§ naturally */
            html,
            body {
                height: auto;
                overflow: auto;
            }

            /* Ìó§Îçî Îçî ÏñáÍ≤å + Í∏ÄÏûê Ï§ÑÏù¥Í∏∞ */
            header {
                height: 30px;
                padding: 0 10px;
                font-size: 11px;
            }

            .brand {
                font-size: 11px;
                gap: 4px;
            }

            .badge {
                font-size: 9px;
                padding: 1px 4px;
            }

            /* Î©îÏù∏ Ìå®Îî© Ï§ÑÏù¥Í∏∞ */
            main {
                position: static;
                inset: auto;
                height: auto;
            }

            /* Ïâò Í∞ÄÎ°ú Ìè≠ ÍΩâ Ï∞®Í≤å */
            .shell {
                height: auto;
            }

            /* header Î∂ÄÎ∂Ñ Ï§ÑÏù¥Í∏∞ */
            .shell-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                font-size: 10px;
            }

            .crumbs {
                font-size: 10px;
            }

            .chip-row {
                gap: 4px;
            }

            /* Î†àÏù¥ÏïÑÏõÉ ‚Üí ÏÑ∏Î°ú 1Ïó¥ */
            section {
                overflow: visible;
            }

            .leftcol,
            .rightcol {
                flex: none;
                width: 100%;
            }

            /* PANEL Í∏∞Î≥∏ Ìå®Îî© Ï§ÑÏù¥Í∏∞ */
            .panel {
                padding: 8px 10px;
                border-radius: 10px;
                gap: 6px;
            }

            /* ÌÖçÏä§Ìä∏ ÏûëÏùÄ ÌôîÎ©¥ÏóêÏÑú Í∞ÄÎèÖÏÑ± Ïú†ÏßÄ */
            table {
                font-size: 10px;
            }

            th {
                font-size: 9px;
            }

            td {
                font-size: 10px;
                padding: 5px 3px;
            }

            /* ÏÉÅÌÉúÏ†ê ÌÅ¨Í∏∞ ÏÇ¥Ïßù Ï§ÑÏù¥Í∏∞ */
            .statusDot {
                width: 7px;
                height: 7px;
                margin-right: 3px;
            }

            /* ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ¬∑ Unlock ÏûÖÎ†•Ïπ∏ ¬∑ HUD Î™®Îëê Ìè≠ 100% */
            #subjectInfo,
            #unlockBox,
            .hud {
                width: 100%;
                font-size: 10px;
                padding: 6px;
            }

            /* ÎØ∏ÎãàÎßµ / city ÏòÅÏó≠ ÎÜíÏù¥ Ï§ÑÏù¥Í∏∞ */
            .map-inner {
                min-height: 180px;
            }

            /* radar / datastream Ïï†ÎãàÎ©îÏù¥ÏÖò Í∞ïÎèÑ Í∞êÏÜå (Î™®Î∞îÏùº Î∂ÄÌïò Î∞©ÏßÄ) */
            .dossier .radar {
                filter: blur(6px);
            }

            /* logs Í∏∏Ïù¥ Ï°∞Ï†à */
            .logs {
                max-height: 24dvh;
                font-size: 10px;
            }

            /* MINI Ïπ¥Îìú Î™®Î∞îÏùºÏóêÏÑúÎäî ÌôîÎ©¥ Î∞ñÏúºÎ°ú Ïïà ÎÇòÍ∞ÄÍ≤å */
            .mini {
                max-width: 180px;
                font-size: 10px;
                padding: 6px 8px;
            }

            /* Î≤ÑÌäº ÌÅ¨Í∏∞ Ï§ÑÏù¥Í∏∞ */
            .btn {
                font-size: 10px;
                padding: 5px 10px;
            }

            .btn.small {
                padding: 4px 8px;
                font-size: 9px;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="brand">
            <span>NACM</span>
            <div>Íµ≠Í∞ÄÎä•Î†•Í∞úÎ∞úÎ∞èÍ¥ÄÎ¶¨Ïõê // OBSERVER NODE</div>
        </div>
        <div class="badge">INTERNAL // LEVEL 3</div>
    </header>

    <main>
        <div class="shell">
            <div class="shell-header">
                <div class="crumbs">
                    NACM // <span>SUBJECT LINK CONSOLE</span>
                </div>
                <div class="chip-row">
                    <div class="chip"><b>ZONE</b> S-03 // METRO</div>
                    <div class="chip danger"><b>ALERT</b> PATTERN MATCH 2Y AGO</div>
                    <div class="chip ok"><b>STATUS</b> LINK STANDBY</div>
                </div>
            </div>

            <!-- LOGIN -->
            <section id="login" class="panel">
                <div class="login-inner">
                    <div class="login-title">
                        NACM LINK // <span>AGENT AUTH</span>
                    </div>
                    <p class="muted">
                        ÌòÑÏû• ÏöîÏõê Ïù∏Ï¶ù ÌõÑ, Í≥†ÏúÑÌóò Ï¥àÎä•Î†•Ïûê Í¥ÄÏ∞∞ ÏΩòÏÜîÏóê Ï†ëÏÜçÌï† Ïàò ÏûàÏäµÎãàÎã§.
                        Ïù∏Ï¶ù Ï†ïÎ≥¥Îäî ÎÇ¥Î∂Ä ÎßùÏùÑ ÌÜµÌï¥ ÏïîÌò∏Ìôî Ï†ÑÏÜ°Îê©ÎãàÎã§.
                    </p>
                    <div class="kv" style="margin-top:6px">
                        <b>Agent ID</b>
                        <div><input type="text" value="E-3 / FIELD" disabled></div>
                        <b>Zone</b>
                        <div><input type="text" value="ÏÑúÏö∏Í∂åÏó≠ S-03" disabled></div>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;margin-top:8px">
                        <button class="btn" id="btnAuth">
                            LINK AUTH
                        </button>
                        <span class="muted">Ïù∏Ï¶ù ÌõÑ ÎåÄÏÉÅ Î¶¨Ïä§Ìä∏Í∞Ä ÌôúÏÑ±ÌôîÎê©ÎãàÎã§.</span>
                    </div>
                </div>
            </section>

            <!-- CONSOLE -->
            <section id="console" class="hidden">
                <div class="leftcol">
                    <div class="panel">
                        <h3>SUBJECT // INDEX</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>NAME</th>
                                    <th>STATE</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="tbody"></tbody>
                        </table>
                        <div class="muted" style="margin-top:4px">
                            ¬∑ ÌÅ¥Î¶≠ Ïãú ÎåÄÏÉÅ ÏÉÅÏÑ∏ + ÎßÅÌÅ¨ HUD ÎèôÍ∏∞Ìôî
                        </div>
                    </div>
                </div>

                <div class="rightcol">
                    <div class="panel dossier" id="dossier">
                        <h3>SELECTED // SUBJECT</h3>

                        <!-- ÏÑ†ÌÉùÎêú Ïù∏Î¨º Ï†ïÎ≥¥ -->
                        <div id="subjectInfo" class="kv">
                            <b>Ïù¥Î¶Ñ</b>
                            <div>‚Äî</div>
                            <b>ÏÉÅÌÉú</b>
                            <div>‚Äî</div>
                            <b>Îä•Î†•</b>
                            <div>‚Äî</div>
                            <b>Î©îÎ™®</b>
                            <div>ÏôºÏ™Ω Î™©Î°ùÏóêÏÑú ÎåÄÏÉÅÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</div>
                            <b>ÎßàÏßÄÎßâ Í∞±Ïã†</b>
                            <div>‚Äî</div>
                        </div>

                        <div id="subjectDetail" class="hud hidden" style="margin-top:6px;">
                            <!-- More Î≤ÑÌäº ÎàåÎ†ÄÏùÑ Îïå ÏÉÅÏÑ∏ Ï†ïÎ≥¥Í∞Ä Ïó¨Í∏∞Î°ú Îì§Ïñ¥Í∞ê -->
                        </div>

                        <div class="kv" id="unlockBox" style="margin-top:6px">
                            <b>UNLOCK</b>
                            <div style="display:flex;gap:4px;align-items:center;">
                                <input id="unlockInput" type="password" placeholder="ÏΩîÎìú ÏûÖÎ†•" style="flex:1;min-width:0;">
                                <button class="btn small" id="btnUnlock">OK</button>
                            </div>
                        </div>

                        <!-- Mini Map HUD -->
                        <div class="map-inner">
                            <div class="city" id="cityView">
                                <div class="cityContent">
                                    <div class="datastream"></div>
                                    <div class="radar"></div>
                                    <!-- blips injected here -->
                                </div>
                            </div>
                        </div>
                        <!-- Î°úÍ∑∏ -->
                        <div class="logs" id="logs"></div>
                    </div>
            </section>
        </div>
    </main>



    <script>
        // ===== Helpers =====
        function timeAgo(d) {
            if (!(d instanceof Date)) d = new Date(d);
            const sec = Math.floor((Date.now() - d.getTime()) / 1000);
            if (sec < 60) return sec + "s Ï†Ñ";
            const m = Math.floor(sec / 60);
            if (m < 60) return m + "m Ï†Ñ";
            const h = Math.floor(m / 60);
            if (h < 24) return h + "h Ï†Ñ";
            const dd = Math.floor(h / 24);
            return dd + "d Ï†Ñ";
        }
        function ago(sec) {
            return new Date(Date.now() - sec * 1000);
        }

        function banner(msg) {
            const b = document.getElementById('toast');
            if (!b) return;
            b.textContent = msg;
            b.classList.add('show');
            setTimeout(() => b.classList.remove('show'), 1600);
        }

        function log(msg) {
            const logs = document.getElementById('logs');
            if (!logs) return;
            const el = document.createElement('div');
            el.className = 'log';
            const t = new Date();
            const hh = String(t.getHours()).padStart(2, '0');
            const mm = String(t.getMinutes()).padStart(2, '0');
            el.textContent = `[${hh}:${mm}] ${msg}`;
            logs.prepend(el);
            while (logs.children.length > 60) {
                logs.lastChild.remove();
            }
        }

        // ===== Data : 2ÎÖÑ Ï†Ñ Í∏∞Ï§Ä LOCKED ÏÉÅÌÉú Í∏∞Î°ù =====
        const subjects = [
            { id: 'khw', name: 'Í∞ïÌòÑÏö∞', status: 'locked', ability: 'Î¨ºÏßàÎ∂ÑÌï¥', note: '2ÎÖÑ Ï†Ñ ÏàòÏö©ÏÜå Î∂ïÍ¥¥ ÏßÅÏ†Ñ, Ïã§ÌóòÎèô BÎèô ÎßàÏßÄÎßâ Í∏∞Î°ù.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'sjh', name: 'ÏÑúÏßÄÌò∏', status: 'locked', ability: 'ÏãúÍ∞ÑÏ°∞Ï¢Ö', note: 'Î∂ïÍ¥¥ ÏßÄÏ†ê Ï§ëÏã¨Î∂Ä Ïù∏Í∑ºÏóêÏÑú ÎπÑÏ†ïÏÉÅÏ†ÅÏù∏ ÏãúÍ∞Ñ ÏôúÍ≥° Ìè¨Ï∞© ÌõÑ Í∏∞Î°ù ÎÅäÍπÄ.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'idy', name: 'ÏûÑÎèÑÏú§', status: 'locked', ability: 'Ï†ïÏã†ÏßÄÎ∞∞', note: 'Í¥ÄÏ∞∞ Î°úÍ∑∏ Îã§Ïàò ÏÇ≠Ï†ú. 2ÎÖÑ Ï†Ñ Í∏∞Î°ù Í∏∞Ï§Ä, Ï†ïÏã† Í∞úÏûÖ ÏùòÏã¨.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'cjk', name: 'ÏµúÏ§ÄÌòÅ', status: 'locked', ability: 'Ï†ïÎ≥¥Ï°∞Ïûë', note: 'Ï∂úÏûÖÍ∏∞Î°ù Î∞è CCTV Î°úÍ∑∏ Ï°∞Ïûë ÌùîÏ†Å. Î∂ïÍ¥¥ ÎãπÏùº ÌñâÏ†Å Î∂àÎ™Ö.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'ktj', name: 'ÍπÄÌÉúÏ§Ä', status: 'locked', ability: 'Ï§ëÎ†•Ï°∞Ïûë', note: 'ÏàòÏö©Íµ¨Ïó≠ Ï†ÑÏ≤¥ Ï§ëÎ†• Î≥ÄÎèôÏùò Ï§ëÏã¨. Í≤©Î¶¨ ÏßÅÏ†ÑÍπåÏßÄ Í≥ºÎ∂ÄÌïò ÏÉÅÌÉú.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'lmw', name: 'Ïù¥ÎØºÏö∞', status: 'locked', ability: 'ÎèÖÏÑ±Î≥ÄÌôò', note: 'ÎèÖÏÑ± Íµ¨Ïó≠ Ïú†Ï∂ú ÏÇ¨Í≥† Ïù¥ÌõÑ, Î≥ÑÎèÑ ÎèÖÎ¶Ω Íµ¨Ïó≠ÏúºÎ°ú Í≤©Î¶¨.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'yhj', name: 'Ïú§ÌïòÏßÑ', status: 'locked', ability: 'ÏóêÎÑàÏßÄÌè≠Î∞ú', note: 'Î∂ïÍ¥¥ ÏßÄÏ†ê ÏóêÎÑàÏßÄ Ìè≠Ïã¨ÏßÄ. Ïù¥ÌõÑ Í∏∞Î°ù ÏóÜÏùå.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'lsh', name: 'Ïù¥ÏàòÌò∏', status: 'locked', ability: 'Í∏∞ÏñµÏ°∞Ïûë', note: 'Í¥ÄÏ∞∞ Ïù∏Î†•Îì§Ïùò Í∏∞Ïñµ Í≥µÎ∞± Îã§Ïàò Î≥¥Í≥†. Í≥µÏãù Í∏∞Î°ùÍ≥º ÏßÑÏà† Î∂àÏùºÏπò.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'cmg', name: 'Ï≤úÎØºÍ≤∞', status: 'locked', ability: 'Î¨ºÎ¶¨Í∞ïÌôî', note: '2ÎÖÑ Ï†Ñ ÏàòÏö©ÏÜå Î∂ïÍ¥¥ ÎãπÏãú, Ïô∏Î∂Ä ÎåÄÍ∏∞Ï°∞ Ïù∏Í∑ºÏóêÏÑú ÎßàÏßÄÎßâ Ìè¨Ï∞©.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'gjw', name: 'Í∞ïÏßÄÏõê', status: 'locked', ability: 'Ïã†Ï≤¥Ïû¨ÏÉù', note: 'Ï§ëÏÉÅ ÏûÖÏóàÏùåÏóêÎèÑ ÏÉùÏ°¥. Ïù¥ÌõÑ ÎèÖÎ¶Ω Í≤©Î¶¨Ïã§Î°ú Ïù¥ÏÜ° Í∏∞Î°ù ÌõÑ Îç∞Ïù¥ÌÑ∞ ÎÅäÍπÄ.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'osj', name: 'Ïò§ÏÑ∏Ï§Ä', status: 'locked', ability: 'ÏÉùÏ≤¥Ï°∞Ïûë', note: 'Î∂ïÍ¥¥ ÏßÅÏ†Ñ, Ïã§ÌóòÏ≤¥ Îã§ÏàòÏùò ÏÉùÏ≤¥ Î∞òÏùë Ïù¥ÏÉÅÏπò Î≥¥Í≥†Îê®.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'jhs', name: 'Ï†ïÌòÑÏàò', status: 'locked', ability: 'Ï†ÑÏûêÍ∏∞Ìåå', note: 'Í¥ÄÏ∏° Ïû•ÎπÑ Í≥ºÎ∂ÄÌïò Ïú†Î∞ú. ÌÜµÏã† Î°úÍ∑∏ ÎåÄÎüâ ÏÜêÏã§Ïùò ÏõêÏù∏ÏúºÎ°ú Ï∂îÏ†ï.', updatedAt: ago(60 * 60 * 24 * 730) }
        ];

        const statusMap = {
            monitoring: { label: 'Monitoring', dot: 's-green' },
            missing: { label: 'Missing', dot: 's-red' },
            unknown: { label: 'Unknown', dot: 's-gray' },
            locked: { label: 'Locked', dot: 's-yellow' }
        };

        // ===== Unlock Ïù¥ÌõÑ Ï†ÅÏö©Îê† "ÌòÑÏû¨ Ï†ïÎ≥¥" ÌîÑÎ°úÌïÑ =====
        const unlockProfiles = {
            khw: {
                status: "monitoring",
                ability: "Î¨ºÏßàÎ∂ÑÌï¥",
                note: "ÌòÑÏû¨: Ïô∏Î∂Ä ÎπÑÍ≥µÍ∞ú ÏãúÏÑ§ÏóêÏÑú Ï†úÌïúÏ†Å ÌòëÎ†• Ï§ë. Î¨ºÏßà Î∂ÑÌï¥ Îä•Î†•ÏùÄ ÏïàÏ†ïÌôî ÌîÑÎ°úÌÜ†ÏΩú Ï†ÅÏö© ÏÉÅÌÉú."
            },
            sjh: {
                status: "monitoring",
                ability: "ÏãúÍ∞ÑÏ°∞Ï¢Ö",
                note: "ÌòÑÏû¨: ÏãúÍ∞Ñ ÏôúÍ≥° Î≤îÏúÑ Ï∂ïÏÜå. ÏùòÎèÑÏ†Å ÏÇ¨Ïö©Ïóê ÎåÄÌïú ÏûêÍ∞Ä Î≥¥Í≥†Í∞Ä Í∞ÄÎä•Ìï¥Ïßê."
            },
            idy: {
                status: "monitoring",
                age: "30ÏÑ∏",
                ability: "Ï†ïÏã†ÏßÄÎ∞∞",
                sideEffect: "Îä•Î†• ÏÇ¨Ïö© ÌõÑ ÎåÄÏÉÅÏùò Í∞êÏ†ïÏù¥ ÏùºÏãúÏ†ÅÏúºÎ°ú Ï†ÑÏù¥ÎêòÎäî ÌòÑÏÉÅÏù¥ ÌôïÏù∏Îê®.",
                family: {
                    relation: "Î∂ÄÎ™®Îãò, ÎàÑÎÇò ÏûÑÍ∞ÄÏùÄ(33ÏÑ∏)",
                    note: "ÏàòÏö© Ï°∞Ïπò Ïù¥ÌõÑ Í∞ÄÏ°±Í≥ºÏùò Ï†ëÏ¥âÏùÑ Ï†ÑÎ©¥ Ï§ëÎã®Ìïú ÏÉÅÌÉú. Ïù¥Îäî Îä•Î†•ÏùÑ ÏïÖÏö©ÌïòÎ†§Îäî Ïô∏Î∂Ä ÏÑ∏Î†•ÏúºÎ°úÎ∂ÄÌÑ∞ Í∞ÄÏ°±ÏùÑ Î≥¥Ìò∏ÌïòÍ∏∞ ÏúÑÌïú ÏûêÎ∞úÏ†Å Îã®Ï†àÎ°ú ÌåêÎã®Îê®."
                },
                lifestyle: {
                    substances: "Îã¥Î∞∞¬∑Ï£ºÎ•ò¬∑ÏßÑÏ†ïÏ†úÎ•ò ÏïΩÎ¨º Î≥µÌï© ÏÇ¨Ïö© Ïù¥Î†• ÌôïÏù∏Îê®.",
                },
                psychology: {
                    tendency: "ÏûêÏã†Ïùò Í∞êÏ†ïÍ≥º ÌÉÄÏù∏Ïùò Í∞êÏ†ïÏùÑ Íµ¨Î∂ÑÌïòÎäî Îç∞ ÏßÄÏÜçÏ†ÅÏù∏ Ïñ¥Î†§ÏõÄÏùÑ Í≤™Îäî Í≤ÉÏúºÎ°ú Î≥¥ÏûÑ. Í∞êÏ†ï Ï†ÑÏù¥Ïóê Îî∞Î•∏ ÌîºÎ°ú ÎàÑÏ†ÅÏúºÎ°ú ÏòàÎØºÎèÑÍ∞Ä ÎÜíÏïÑÏßÑ ÏÉÅÌÉúÍ∞Ä Î∞òÎ≥µÏ†ÅÏúºÎ°ú Í¥ÄÏ∞∞Îê®.",
                },
                admission: "Í≥ºÍ±∞ 3ÏÑ† Íµ≠ÌöåÏùòÏõê Ïû•ÏÑùÍ∏∞Ïùò Î≥¥Ï¢åÏßÑÏúºÎ°ú Ïû¨ÏßÅÌïòÎ©∞ Îä•Î†• ÏÇ¨Ïö©Ïù¥ ÏùòÏã¨ÎêòÎäî ÏÇ¨Í±¥Ïóê Ïó∞Î£®Îê®. ÏÇ¨Í±¥ Ïù¥ÌõÑ, ÎπÑÏûêÎ∞úÏ†Å Îä•Î†• Î∞úÌòÑÏúºÎ°ú Ïù∏Ìïú ÏúÑÌóòÏÑ±Ïù¥ ÌôïÏù∏ÎêòÏñ¥ Î≥¥Ìò∏¬∑Í≤©Î¶¨ Ï°∞ÏπòÍ∞Ä ÏãúÌñâÎê®.",
                note: "ÌòÑÏû¨ Webron Ïô∏ Î≥µÏàòÏùò Ïù¥Ïùµ ÏßëÎã®Ïù¥ ÎåÄÏÉÅÏùò Îä•Î†• ÌôïÎ≥¥Î•º ÏãúÎèÑÌïòÎäî Ï†ïÌô©Ïù¥ ÏßÄÏÜç Î≥¥Í≥†Îê®.",
            },
            cjk: {
                status: "monitoring",
                ability: "Ï†ïÎ≥¥Ï°∞Ïûë",
                note: "ÌòÑÏû¨: Îç∞Ïù¥ÌÑ∞ ÏúÑÏ°∞ ÌùîÏ†Å ÏûêÏ≤¥Î•º Ï∂îÏ†ÅÌïòÍ∏∞ ÏúÑÌïú ÎÇ¥Î∂Ä ÎèÑÍµ¨ Ïó≠Ìï†Î°ú ÌôúÏö© Ï§ë."
            },
            ktj: {
                status: "monitoring",
                ability: "Ï§ëÎ†•Ï°∞Ïûë",
                note: "ÌòÑÏû¨: Ï§ëÎ†• ÌïÑÎìú Ï°∞Ï†à Î≤îÏúÑÍ∞Ä ÏïàÏ†ïÌôî Îã®Í≥Ñ. Ïã§Ï†Ñ Ìà¨ÏûÖ Í∞ÄÎä•ÏÑ± Í≤ÄÌÜ† Ï§ë."
            },
            lmw: {
                status: "monitoring",
                age: "24ÏÑ∏",
                family: {
                    relation: "Î∂ÄÎ™®Îãò, Ìòï Ïù¥Í∞ïÏö∞(27ÏÑ∏)",
                    note: "Î∂ÄÎ™®Îäî Í≤ΩÏ†úÏ†Å ÏßÄÏõêÎßå ÏßÄÏÜçÌï¥ÏôîÏúºÎ©∞, Ï†ïÏÑúÏ†Å ÍµêÎ•òÎäî Í±∞Ïùò ÏóÜÎäî Í≤ÉÏúºÎ°ú ÌååÏïÖÎê®."
                },
                ability: "ÎèÖÏÑ±Î≥ÄÌôò",
                sideEffect: "Îä•Î†• ÏÇ¨Ïö© Ïó¨Î∂ÄÏôÄ Î¨¥Í¥ÄÌïòÍ≤å Ï≤¥ÎÇ¥Ïóê ÎØ∏ÎüâÏùò ÎèÖÏÑ± Î¨ºÏßàÏù¥ ÏÉÅÏãú ÏûîÎ•òÌïòÎäî ÌòÑÏÉÅÏù¥ ÌôïÏù∏Îê®.",
                lifestyle: {
                    substances: "Ìù°Ïó∞ Ïù¥Î†• ÏûàÏùå. Ï£ºÎ•ò Î∞è ÏïΩÎ¨º ÏÇ¨Ïö© Ïù¥Î†•ÏùÄ ÌôïÏù∏ÎêòÏßÄ ÏïäÏùå."
                },
                psychology: {
                    tendency: "ÎåÄÏ≤¥Î°ú Ïò®ÌôîÌïòÍ≥† ÏòàÏùòÎ∞îÎ•∏ ÌÉúÎèÑÎ•º Î≥¥Ïù¥ÎÇò, ÌïÑÏöî Ïãú ÏÉÅÌô©ÏùÑ ÏûêÏã†ÏóêÍ≤å Ïú†Î¶¨Ìïú Î∞©Ìñ•ÏúºÎ°ú Ï°∞Ï†ïÌïòÎ†§Îäî Í≤ΩÌñ•Ïù¥ Í¥ÄÏ∞∞Îê®. Ïô∏Î°úÏõÄÏùÑ Í¥ÄÍ≥Ñ ÌòïÏÑ±Ïùò ÏàòÎã®ÏúºÎ°ú ÌôúÏö©ÌïòÎäî ÏÇ¨Î°ÄÍ∞Ä Î≥¥Í≥†Îê®."
                },
                admission: "Ï¥àÍ∏∞ Îä•Î†• Î∞úÌòÑ Ïãú ÎèÖÏÑ± Î¨ºÏßà Ìè≠Ï£ºÎ°ú Ïù∏Ìïú ÏÇ¨Í≥†Í∞Ä Î∞úÏÉùÌïòÏó¨ Îã§ÏàòÏùò Ïù∏Î™Ö ÌîºÌï¥Í∞Ä Î≥¥Í≥†Îê®. Ìï¥Îãπ ÏÇ¨Í≥†Î°ú Ìòï Ïù¥Í∞ïÏö∞ ÎòêÌïú Î∂ÄÏÉÅÏùÑ ÏûÖÏùÄ ÏÇ¨Ïã§Ïù¥ ÌôïÏù∏Îê®.",
                note: "ÏµúÍ∑º ÏöîÏõêÏùÑ ÌäπÏ†ï Íµ¨Ïó≠ÏúºÎ°ú Ïú†ÎèÑÌïòÎ†§ Ìïú Ï†ïÌô©Ïù¥ Í¥ÄÏ∞∞Îê®. ÏùòÎèÑ ÌååÏïÖÏù¥ ÌïÑÏöîÌïòÎ©∞, ÏµúÏ§ÄÌòÅÍ≥ºÏùò ÎπÑÍ≥µÏãù Ï†ëÏ¥â Ïù¥Î†•Ïù¥ Ï∂îÍ∞Ä Î≥¥Í≥†Îê®."
            },
            yhj: {
                status: "monitoring",
                age: "30ÏÑ∏",
                family: {
                    relation: "Îì±Î°ùÎêú Í∞ÄÏ°± ÏóÜÏùå",
                    note: "Ïû•Í∏∞Í∞Ñ Îã®ÎèÖ ÏÉùÏ°¥ Í∏∞Î°ùÏù¥ ÌôïÏù∏Îê®."
                },
                ability: "ÏóêÎÑàÏßÄ Ìè≠Î∞ú",
                sideEffect: "ÎåÄÍ∑úÎ™® ÏóêÎÑàÏßÄ Î∞©Ï∂ú Ïù¥ÌõÑ Ï≤¥Ïò® Ï°∞Ï†à Í∏∞Îä• ÏÉÅÏã§ Î∞è Í∑πÏã¨Ìïú ÌîºÎ°ú ÎàÑÏ†ÅÏù¥ ÌôïÏù∏Îê®.",
                lifestyle: {
                    substances: "Ï£ºÎ•ò¬∑Îã¥Î∞∞¬∑ÏïΩÎ¨º ÏÇ¨Ïö© Ïù¥Î†• ÏóÜÏùå."
                },
                psychology: {
                    tendency: "Í≥†ÏúÑÌóò ÏÉÅÌô© Î∞è ÌååÍ¥¥Ï†Å ÏûêÍ∑πÏùÑ ÌÜµÌïú ÏûêÍ∏∞ Ï°¥Ïû¨Í∞ê ÌôïÏù∏ Í≤ΩÌñ•Ïù¥ Í¥ÄÏ∞∞Îê®. Ï∂©Îèô Ï°∞Ï†à Îä•Î†•Ïùò Î∂àÏïàÏ†ïÏÑ±Ïù¥ Î∞òÎ≥µÏ†ÅÏúºÎ°ú Î≥¥Í≥†Îê®."
                },
                admission: "Ï¥àÍ∏∞ Îä•Î†• Î∞úÌòÑ Ïù¥ÌõÑ Í∞úÏù∏Ï†Å Ï∂©ÎèôÏóê ÏùòÌïú Î¨¥Î∂ÑÎ≥ÑÌïú ÏóêÎÑàÏßÄ Î∞©Ï∂ú ÏÇ¨Î°ÄÍ∞Ä Îã§Ïàò Î≥¥Í≥†Îê®. Ïù¥Î°ú Ïù∏Ìïú ÎèÑÏãú Í∏∞Î∞ò ÏãúÏÑ§ ÏÜêÍ¥¥ Î∞è Ïù∏Î™Ö ÌîºÌï¥ ÏúÑÌóòÏù¥ ÌôïÏù∏ÎêòÏñ¥ Î≥¥Ìò∏¬∑Í≤©Î¶¨ Ï°∞ÏπòÍ∞Ä ÏãúÌñâÎê®.",
                note: "ÏµúÍ∑º ÏóêÎÑàÏßÄ Î∞©Ï∂úÎüâÏùò ÏûêÍ∞Ä Ï°∞Ï†à Îä•Î†•Ïù¥ ÏùºÎ∂Ä ÌöåÎ≥µÎêú Í≤ÉÏúºÎ°ú Î≥¥Í≥†Îê®. ÎèÖÎ¶Ω ÌôúÎèôÏùÑ ÏßÄÏÜçÌïòÍ≥† ÏûàÏúºÎ©∞, ÎπÑÍ≥µÏãùÏ†Å Ï∂îÏ¢Ö ÏßëÎã®Ïùò Ï°¥Ïû¨Í∞Ä Ï∂îÍ∞Ä Í¥ÄÏ∏°Îê®."
            },
            lsh: {
                status: "monitoring",
                ability: "Í∏∞ÏñµÏ°∞Ïûë",
                note: "ÌòÑÏû¨: Ï¶ùÏñ∏ Î≥¥Ìò∏ Î∞è Ïã†Ïõê Î≥¥Ìò∏ Î™©Ï†ÅÏùò Ï†úÌïúÏ†Å ÏÇ¨Ïö© ÌóàÍ∞Ä. ÎÇ®Ïö© Î∞©ÏßÄ ÌîÑÎ°úÌÜ†ÏΩú ÎèôÏãú Ïö¥Ïö©."
            },
            cmg: {
                status: "monitoring",
                age: "29ÏÑ∏",
                family: {
                    relation: "7ÎÇ®Îß§ Ï§ë Ï≤´Ïß∏",
                    note: "Î∂ÄÎ™®Îäî ÏÇ¨Í≥†Î°ú ÏÇ¨ÎßùÌïòÏòÄÏúºÎ©∞, Îã§ÏÑØÏß∏ ÎèôÏÉù ÎòêÌïú Î≥ÑÎèÑ ÏÇ¨Í≥†Î°ú ÏÇ¨ÎßùÌïú ÏÇ¨Ïã§Ïù¥ ÌôïÏù∏Îê®."
                },
                ability: "Ïã†Ï≤¥Ïùò Î¨ºÎ¶¨Ï†Å Í∞ïÌôî",
                sideEffect: "Í≥ºÎèÑÌïú Ïã†Ï≤¥ Í∞ïÌôî ÌõÑ Í∑ºÏú° ÌååÏó¥ Î∞è ÎØ∏ÏÑ∏ Í≥®Ï†àÏù¥ Î∞úÏÉùÌïòÎäî Í≤ΩÌñ•Ïù¥ Î≥¥Í≥†Îê®.",
                lifestyle: {
                    substances: "Í∏¥Ïû• Ïãú ÏÜêÌÜ± Î¨ºÏñ¥ÎúØÍ∏∞ Î∞è Íµ¨Í∞ï ÎÇ¥ Ï†êÎßâÏùÑ ÏîπÎäî Î∞òÎ≥µÏ†Å ÌñâÎèôÏù¥ Í¥ÄÏ∞∞Îê®. ÏÜêÎ™©ÏãúÍ≥ÑÎ•º ÏûêÏ£º ÎßåÏßÄÎ©∞, Î∞©Ìñ• Í∞êÍ∞Å Î∞è Í∏∞Í≥Ñ Ï°∞Ïûë Îä•Î†•ÏùÄ ÎÇÆÏùÄ Í≤ÉÏúºÎ°ú ÌèâÍ∞ÄÎê®."
                },
                psychology: {
                    tendency: "ÏÇ¨Í≥† Í≥ºÏ†ïÏù¥ Îã®Ïàú¬∑ÏßÅÏÑ†Ï†ÅÏù¥Î©∞ Î≥µÏû°Ìïú ÏÉÅÌô©ÏùÑ ÌöåÌîºÌïòÎäî Í≤ΩÌñ•Ïù¥ ÏûàÏùå. Ï£ºÏöî ÌåêÎã®ÏùÑ ÏßÅÍ∞êÏóê ÏùòÏ°¥ÌïòÎäî ÏÇ¨Î°ÄÍ∞Ä Î∞òÎ≥µÏ†ÅÏúºÎ°ú ÌôïÏù∏Îê®."
                },
                admission: "Îã§ÏÑØÏß∏ ÎèôÏÉù ÏÇ¨Îßù ÏßÅÌõÑ Ï∂©ÎèôÏ†Å ÌñâÎèôÏúºÎ°ú ÏùÄÌñâ Í∞ïÎèÑ ÏãúÎèÑÍ∞Ä Î∞úÏÉùÌïòÏòÄÏúºÎ©∞, Ïù¥ Í≥ºÏ†ïÏóêÏÑú ÎπÑÏ†ïÏÉÅÏ†Å Ïã†Ï≤¥ Í∞ïÌôî ÏÇ¨Ïö©Ïù¥ ÌôïÏù∏Îê®. Í≥µÍ≥µ ÏïàÏ†Ñ ÏúÑÌóòÏùÑ Í∑ºÍ±∞Î°ú Î≥¥Ìò∏¬∑Í≤©Î¶¨ Ï°∞ÏπòÍ∞Ä ÏãúÌñâÎê®.",
                note: "ÌòÑÏû¨ NACM ÏÜåÏÜç ÌòÑÏû• ÏöîÏõêÏúºÎ°ú Ïû¨Î∞∞ÏπòÎêòÏñ¥ Í≥†ÏúÑÌóò ÏûÑÎ¨¥Ïóê Ïö∞ÏÑ† Ìà¨ÏûÖÎêòÎäî Ï†ÑÎã¥ ÏöîÏõêÏúºÎ°ú Ïö¥ÏòÅ Ï§ëÏûÑ."
            },
            gjw: {
                status: "monitoring",
                age: "30ÏÑ∏",
                family: {
                    relation: "Î°úÎ¥á Í∞ú ‚ÄòÎèÑÍ∑∏‚Äô",
                    note: "ÌòÑÏû¨ÍπåÏßÄ ÎèÑÍ∑∏ÏôÄ Ïû•Í∏∞Í∞Ñ ÎèôÌñâÌïòÎ©∞ ÏÉùÏ°¥ÏùÑ ÏßÄÏÜçÌï®."
                },
                ability: "ÏÉùÏ≤¥Ï°∞Ïûë",
                sideEffect: "ÏπòÎ™ÖÏÉÅ Ïû¨ÏÉù Î∞è ÎåÄÎüâ Ï°∞ÏßÅ Ïû¨ÏÉù Ïãú Í≥ºÎ∂ÄÌïò Í≤åÏù¥ÏßÄÍ∞Ä Ï∂ïÏ†ÅÎêòÎ©∞, Î∞©Ï∂ú Ïãú Ï∂ïÏ†ÅÎüâÏóê ÎπÑÎ°ÄÌïú ÌÜµÏ¶ù Í∑πÎåÄÌôî Î∞è Îã®Í∏∞Ï†Å ÌñâÎèô Î∂àÎä• ÏÉÅÌÉúÍ∞Ä Î∞úÏÉùÌï®.",
                lifestyle: {
                    substances: "Ï£º Ïù¥Îèô ÏàòÎã®ÏúºÎ°ú Î¨¥Í¥ë Î∏îÎûô Íµ∞Ïö©Ìòï Ïò§ÌÜ†Î∞îÏù¥Î•º ÏÇ¨Ïö©ÌïòÎ©∞, Ïû•Í±∞Î¶¨ Ïù¥Îèô Î∞è Ï†ÑÌà¨ ÌöåÌîºÏóê ÌôúÏö©Ìï®."
                },
                psychology: {
                    tendency: "ÌÉÄÏù∏Ïóê ÎåÄÌïú Ïã†Î¢∞ Î∞è Í≥µÍ∞ê Î∞òÏùëÏù¥ ÌòÑÏ†ÄÌûà Ï†úÌïúÏ†ÅÏù¥Î©∞, Ïù∏Í∞ÑÏùÑ ÎèÖÎ¶ΩÎêú Í¥ÄÍ≥Ñ ÎåÄÏÉÅÏù¥ ÏïÑÎãå Î≥ÄÏàò ÎòêÎäî ÏúÑÌóò ÏöîÏÜåÎ°ú Ïù∏ÏãùÌïòÎäî Í≤ΩÌñ•Ïù¥ ÏßÄÏÜçÏ†ÅÏúºÎ°ú Í¥ÄÏ∞∞Îê®. ÏûêÏú®ÏÑ± Ïπ®Ìï¥ ÏÉÅÌô©Ïóê ÎåÄÌï¥ ÎÜíÏùÄ Í≥µÍ≤© Î∞òÏùëÏùÑ Î≥¥ÏûÑ."
                },
                admission: "Î∂àÎ≤ï Ìà¨Í∏∞Ïû•ÏóêÏÑú Í∞ïÏ†úÎ°ú ÌôúÎèôÌïòÎçò Ï§ë, Ï†ïÏ≤¥ Î∂àÎ™ÖÏùò Ï¥àÎä•Î†• Ï¶ùÌè≠ ÏïΩÎ¨ºÏù¥ Ï£ºÏûÖÎê®. Ïù¥ÌõÑ ÏùòÏãù ÏÜåÏã§ ÏÉÅÌÉúÏóêÏÑú Ï£ºÎ≥Ä Ïù∏ÏõêÏùÑ Î¨¥Ï∞®Î≥ÑÏ†ÅÏúºÎ°ú Í≥µÍ≤©ÌïòÎäî ÏÇ¨Í≥†Í∞Ä Î∞úÏÉùÌñàÏúºÎ©∞, Í≥†ÏúÑÌóò Ï¥àÎä•Î†•Ïûê ÌåêÎã®Ïóê Îî∞Îùº Ï¶âÏãú Í≤©Î¶¨ Î∞è Î≥¥Ìò∏ Î™ÖÎ™©ÏúºÎ°ú ÏàòÏö©ÏÜåÏóê ÏàòÍ∞êÎê®.",
                note: "ÏàòÏö©ÏÜå Î∂ïÍ¥¥ Ïù¥ÌõÑ Ï†ïÏ≤¥Î•º Ïà®Í∏¥ Ï±Ñ ÌôúÎèô Ï§ëÏù¥Î©∞, ÏãúÏ§ëÏóê Î∂àÎ≤ï Ïú†ÌÜµÎêòÎäî Ï¥àÎä•Î†• Í¥ÄÎ†® ÏïΩÎ¨ºÏùÑ ÌÉàÏ∑®¬∑Ï†úÍ±∞ÌïòÎäî ÌñâÏúÑÎ•º ÏßÄÏÜçÌïòÍ≥† ÏûàÏùå. Ìï¥Îãπ ÌôúÎèôÏùÄ ÎÖ∏Î∞îÎ¶∞ Î∞îÏù¥Ïò§ÌÖç Ïú†ÌÜµÎßùÏóê ÎåÄÌïú Î≥¥Î≥µÍ≥º Ïã§Ìóò Îç∞Ïù¥ÌÑ∞ ÍµêÎûÄÏùÑ Î™©Ï†ÅÏúºÎ°ú ÌïòÎ©∞, ÎèôÏãúÏóê ÏïΩÎ¨ºÏùÑ ÌÜµÌïú ÌÉÄÏù∏Ïùò ÏûêÏú®ÏÑ± Ïπ®Ìï¥ ÌñâÏúÑÏóê ÎåÄÌïú Í∞ïÌïú Í±∞Î∂Ä ÏÑ±Ìñ•ÏóêÏÑú Í∏∞Ïù∏Ìïú Í≤ÉÏúºÎ°ú Î∂ÑÏÑùÎê®."
            },
            osj: {
                status: "monitoring",
                age: "31ÏÑ∏",
                family: {
                    relation: "3ÎÇ®Îß§ Ï§ë ÎëòÏß∏",
                    note: "Î∂ÄÎ™®Îäî Î™®Îëê Ïô∏Í≥º ÏùòÏÇ¨Î°ú ÌôïÏù∏Îê®. Ìòï Ïò§ÏÑ∏ÏßÑ(35ÏÑ∏), Ïó¨ÎèôÏÉù Ïò§ÏÑ∏ÏòÅ(29ÏÑ∏)Ïù¥ ÏûàÏúºÎ©∞, ÏùòÍ≥ºÎåÄÌïô Ìá¥Ìïô Ïù¥ÌõÑ Í∞ÄÏ°±Í≥ºÏùò Ïó∞ÎùΩÏùÑ Ï†ÑÎ©¥ Ï§ëÎã®Ìïú ÏÉÅÌÉúÎ°ú ÌååÏïÖÎê®."
                },
                ability: "ÏÉùÏ≤¥Ï°∞Ïûë",
                sideEffect: "Îä•Î†• ÏÇ¨Ïö©Ïù¥ Ïû•ÏãúÍ∞Ñ ÏßÄÏÜçÎêòÍ±∞ÎÇò Ïû•Í∏∞ Îã®ÏúÑ Ïù¥ÏÉÅÏùò Ï°∞ÏûëÏù¥ Î∞òÎ≥µÎê† Í≤ΩÏö∞, Î≥∏Ïù∏Ïùò Í∞êÍ∞Å Ïã†Í≤ΩÏóê Î∂àÏïàÏ†ï ÌòÑÏÉÅÏù¥ Î∞úÏÉùÌïòÎäî ÏÇ¨Î°ÄÍ∞Ä Î≥¥Í≥†Îê®.",
                lifestyle: {
                    substances: "ÏßÑÌÜµÏ†ú¬∑ÏßÑÏ†ïÏ†ú Îì± Îã§ÏñëÌïú ÏïΩÎ¨º ÏÇ¨Ïö© Ïù¥Î†•Ïù¥ ÌôïÏù∏Îê®. ÎåÄÌôî Ïãú ÏÉÅÎåÄÏùò Ïã†Ï≤¥ Î∞òÏùëÍ≥º Íµ¨Ï°∞Î•º Í¥ÄÏ∞∞ÌïòÎäî ÏãúÏÑ† ÌñâÎèôÏù¥ Î∞òÎ≥µÏ†ÅÏúºÎ°ú Í¥ÄÏ∞∞Îê®."
                },
                psychology: {
                    tendency: "ÎèÑÎçïÏ†Å ÌåêÎã® Í∏∞Ï§ÄÏù¥ Í¥ÄÏ∞∞ÎêòÏßÄ ÏïäÏúºÎ©∞, ÌÉÄÏù∏Ïóê ÎåÄÌïú Í≥µÍ∞ê Î∞òÏùëÏù¥ Í∑πÌûà Ï†úÌïúÏ†ÅÏûÑ. Ïù∏Í∞ÑÏùÑ ÎèÖÎ¶ΩÎêú Ïù∏Í≤©Ï≤¥Í∞Ä ÏïÑÎãå Í¥ÄÏ∞∞ Î∞è Ïã§Ìóò ÎåÄÏÉÅÏúºÎ°ú Ïù∏ÏãùÌïòÎäî Í≤ΩÌñ•Ïù¥ ÏßÄÏÜçÏ†ÅÏúºÎ°ú ÌôïÏù∏Îê®."
                },
                admission: "ÏùòÍ≥ºÎåÄÌïô Ïû¨Ìïô Ï§ë Ìï¥Î∂Ä Ïã§Ïäµ Í≥ºÏ†ïÏóêÏÑúÏùò ÎπÑÏ†ïÏÉÅÏ†Å Í¥ÄÏã¨ÏúºÎ°ú ÎÇ¥Î∂Ä Ïã†Í≥†Í∞Ä Ï†ëÏàòÎêòÏóàÏúºÎ©∞, Ïù¥ÌõÑ ÏûêÏßÑ Ìá¥Ìïô Ï≤òÎ¶¨Îê®. Ìá¥Ìïô Ïù¥ÌõÑ Îä•Î†• Î∞úÌòÑÍ≥º Ìï®Íªò Í∞úÏù∏ Ïã§ÌóòÏã§ÏóêÏÑú ÎπÑÏù∏Í∞Ä Ïù∏Ï≤¥ Ïã§ÌóòÏùÑ ÏßÑÌñâÌïú Ï†ïÌô©Ïù¥ ÌôïÏù∏ÎêòÏñ¥ Í≥†ÏúÑÌóò Ï¥àÎä•Î†•Ïûê ÏàòÏö©ÏÜåÏóê ÏàòÍ∞êÎê®.",
                note: "ÌòÑÏû¨ Ïä§ÏúÑÏä§Ïóê ÏûàÎäî ÏÉÅÎ•òÏ∏µ Ï†ÑÏö© ÌîÑÎùºÏù¥Îπó ÏùòÎ£å ÏãúÏÑ§Ïù∏ ÎπåÎùº Î™ΩÌä∏Î†àÎ∞ú(Villa Montreval)Ïóê Ï≤¥Î•ò Ï§ëÏù∏ Í≤ÉÏúºÎ°ú ÌååÏïÖÎê®. ÏÉÅÎ•òÏ∏µ Í≥†Í∞ùÏùÑ ÎåÄÏÉÅÏúºÎ°ú Îä•Î†•ÏùÑ ÎåÄÍ∞ÄÏÑ±ÏúºÎ°ú Ï†úÍ≥µÌïòÍ≥† ÏûàÏúºÎ©∞, Î≥µÏàòÏùò Íµ≠Ï†ú Ïù¥Ïùµ ÏßëÎã®Í≥ºÏùò ÎπÑÍ≥µÏãù Ï†ëÏ¥â Í∞ÄÎä•ÏÑ±Ïù¥ Ï†úÍ∏∞Îê®."
            },
            jhs: {
                status: "monitoring",
                ability: "Ï†ÑÏûêÍ∏∞Ìåå",
                note: "ÌòÑÏû¨: ÌÜµÏã† ÍµêÎûÄ Î∞è Ï†ÑÏûê Î∞©Ïñ¥ ÏûÑÎ¨¥Ïóê Ìà¨ÏûÖ. ÏûêÏã†Ïùò Îä•Î†•ÏúºÎ°ú ÏûÉÏñ¥Î≤ÑÎ¶∞ Í∏∞Î°ù Î≥µÍµ¨Î•º ÏãúÎèÑ Ï§ë."
            }
        };

        // ===== Unlock Code Mapping (Ï∫êÎ¶≠ÌÑ∞Î≥Ñ Ìï¥Ï†ú ÏΩîÎìú) =====
        const unlockCodes = {
            "2702213418": "khw",
            "9803901542": "sjh",
            "1801132063": "idy",
            "3703532255": "cjk",
            "3803602536": "ktj",
            "4703721828": "lmw",
            "3703472877": "yhj",
            "1701163169": "lsh",
            "2602054483": "cmg",
            "4504704271": "gjw",
            "4704713992": "osj",
            "3703413095": "jhs"
        };

        // ===== FirestoreÏóêÏÑú Î∂àÎü¨Ïò® unlockÏùÑ subjectsÏóê Î∞òÏòÅÌïòÎäî Ìï®Ïàò =====
        function applyStoredUnlocks(unlockData) {
            if (!unlockData) {
                // Ï†ÄÏû•Îêú Í≤å ÏóÜÏúºÎ©¥ Í∑∏ÎÉ• Í∏∞Î≥∏ Î™©Î°ùÎßå Í∑∏Î¶º
                renderTable();
                renderBlips();
                return;
            }

            subjects.forEach(s => {
                if (unlockData[s.id]) {
                    const profile = unlockProfiles[s.id];
                    if (profile) {
                        // ÌîÑÎ°úÌïÑÏóê ÏûàÎäî Í∞íÎì§ÏùÑ ÌÜµÏß∏Î°ú ÎçÆÏñ¥Ïì∞Í∏∞ (status, ability, note, age, sideEffect Îì±)
                        Object.assign(s, profile);
                    } else {
                        s.status = "monitoring";
                        s.note = (s.note || "") + " // RESTORED";
                    }

                    s.updatedAt = new Date();
                }
            });

            renderTable();
            renderBlips();
        }

        // Î™®Îìà Ïä§ÌÅ¨Î¶ΩÌä∏ÏóêÏÑú Ïì∏ Ïàò ÏûàÍ≤å windowÏóê Ïò¨Î†§ÎëêÍ∏∞
        window.applyStoredUnlocks = applyStoredUnlocks;

        function unlockByCode(code) {
            const clean = String(code || "").trim();
            if (!clean) {
                banner("CODE EMPTY");
                return false;
            }

            const targetId = unlockCodes[clean];
            if (!targetId) {
                banner("INVALID CODE");
                log("UNLOCK FAIL // CODE " + clean);
                return false;
            }

            const s = subjects.find(x => x.id === targetId);
            if (!s) {
                banner("NO SUBJECT");
                log("UNLOCK FAIL // SUBJECT NOT FOUND");
                return false;
            }

            // Ïù¥ÎØ∏ ÌíÄÎ†§ ÏûàÏúºÎ©¥
            if (s.status !== "locked") {
                banner("ALREADY UNLOCKED");
                log("UNLOCK REDUNDANT // " + s.name);
                selectSubject(s);
                return true;
            }

            // Ïó¨Í∏∞ÏÑú ÏßÑÏßú Ìï¥Ï†ú: 2ÎÖÑ Ï†Ñ Í∏∞Î°ù ‚Üí ÌòÑÏû¨ ÌîÑÎ°úÌïÑÎ°ú ÍµêÏ≤¥
            const profile = unlockProfiles[targetId];

            if (profile) {
                Object.assign(s, profile);
            } else {
                s.status = "monitoring";
                s.note = (s.note || "") + " // CODE UNLOCKED";
            }

            s.updatedAt = new Date();

            // FirestoreÏóê Ï†ÄÏû• ÏöîÏ≤≠ (Î™®Îìà Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä Ï≤òÎ¶¨)
            if (window.saveUnlockState) {
                window.saveUnlockState(targetId);
            }

            renderTable();
            renderBlips();
            selectSubject(s);
            banner("LINK UNLOCKED");
            log("UNLOCK OK // " + s.name + " VIA CODE " + clean);
            return true;
        }

        // ===== DOM refs =====
        const loginSec = document.getElementById('login');
        const consoleSec = document.getElementById('console');
        const tbody = document.getElementById('tbody');
        const subjectInfo = document.getElementById('subjectInfo');
        const cityView = document.getElementById('cityView');
        const cityContent = cityView ? cityView.querySelector('.cityContent') : null;
        const subjectDetail = document.getElementById('subjectDetail');


        const blipEls = new Map();
        let miniEl = null;

        // ===== Auth click =====
        document.getElementById('btnAuth').addEventListener('click', () => {
            loginSec.style.transition = 'opacity .35s ease';
            loginSec.style.opacity = '0';
            setTimeout(() => {
                loginSec.classList.add('hidden');
                consoleSec.classList.remove('hidden');
                loginSec.style.opacity = '1';

                // üî• Firebase Î™®ÎìàÏù¥ ÏûàÏúºÎ©¥ Í±∞Í∏∞ÏÑú unlock Î∂àÎü¨Ïò§ÎùºÍ≥† ÏöîÏ≤≠
                if (window.requestUnlockSync) {
                    window.requestUnlockSync();
                } else {
                    // Firebase Ïó∞Îèô Ï†ÑÏù¥ÎùºÎ©¥ Í∑∏ÎÉ• Í∏∞Î≥∏ Î†åÎçîÎßÅ
                    renderTable();
                    renderBlips();
                }

                banner('LINK ONLINE ‚Äî SAT RELAY ACTIVE');
                log('LINK ONLINE // SUBJECT INDEX SYNC');
            }, 350);
        });

        // ===== Table render =====
        function renderTable() {
            tbody.innerHTML = '';
            subjects.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
      <td><strong>${s.name}</strong></td>
      <td><span class="statusDot ${statusMap[s.status].dot}"></span>${statusMap[s.status].label}</td>
      <td class="actions"></td>
    `;

                // Ìñâ ÌÅ¥Î¶≠ Ïãú Í∏∞Î≥∏ ÏÑ†ÌÉù
                tr.addEventListener('click', () => selectSubject(s));

                // More Î≤ÑÌäº (Ìï¥Ï†úÎêú ÎåÄÏÉÅÎßå)
                const actionsTd = tr.querySelector('.actions');
                if (s.status !== 'locked') {
                    const btn = document.createElement('button');
                    btn.textContent = 'MORE';
                    btn.className = 'btn small more-btn';
                    btn.addEventListener('click', (ev) => {
                        ev.stopPropagation();      // Ìñâ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Îûë Ïïà ÏÑûÏù¥Í≤å
                        selectSubject(s);          // HUDÎèÑ Í∞ôÏù¥ ÎèôÍ∏∞Ìôî
                        showSubjectDetail(s);      // ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ïó¥Í∏∞
                    });
                    actionsTd.appendChild(btn);
                }

                tbody.appendChild(tr);
            });
        }


        // ===== Subject select =====
        function selectSubject(s) {
            if (subjectDetail) {
                subjectDetail.classList.add('hidden');
                subjectDetail.innerHTML = '';
            }

            subjectInfo.innerHTML = `
      <b>Ïù¥Î¶Ñ</b><div><span class="statusDot ${statusMap[s.status].dot}"></span>${s.name}</div>
      <b>ÏÉÅÌÉú</b><div>${statusMap[s.status].label}</div>
      <b>Îä•Î†•</b><div>${s.ability}</div>
      <b>Î©îÎ™®</b><div>${s.note || '‚Äî'}</div>
      <b>ÎßàÏßÄÎßâ Í∞±Ïã†</b><div class="timer" id="selTimer">${timeAgo(s.updatedAt)}</div>
    `;

            log(`[SELECT] ${s.name} ‚Äî ${statusMap[s.status].label}`);
            pingMini(s);

            if (window.selTimerInt) clearInterval(window.selTimerInt);
            window.selTimerInt = setInterval(() => {
                const el = document.getElementById('selTimer');
                if (el) el.textContent = timeAgo(s.updatedAt);
            }, 1000);
            // üîπ Ïû†Í∏à ÎåÄÏÉÅ ÏÑ†ÌÉùÌïòÎ©¥ ÏÉÅÏÑ∏ Î∞ïÏä§ Ïà®Í∏∞Í∏∞
            if (subjectDetail) {
                if (s.status === 'locked') {
                    subjectDetail.classList.add('hidden');
                    subjectDetail.innerHTML = '';
                }
            }
        }

        function showSubjectDetail(s) {
            if (!subjectDetail) return;

            if (s.status === 'locked') {
                subjectDetail.classList.add('hidden');
                subjectDetail.innerHTML = '';
                banner('LOCKED SUBJECT');
                return;
            }

            let html = '';

            if (s.age) {
                html += `<div><b>Ïó∞Î†π</b> : ${s.age}</div>`;
            }
            if (s.sideEffect) {
                html += `<div><b>ÌõÑÏú†Ï¶ù</b> : ${s.sideEffect}</div>`;
            }
            if (s.lifestyle && s.lifestyle.substances) {
                html += `<div><b>ÏÉùÌôú ÏäµÍ¥Ä</b> : ${s.lifestyle.substances}</div>`;
            }
            if (s.psychology && s.psychology.tendency) {
                html += `<div><b>ÏÑ±Ìñ•</b> : ${s.psychology.tendency}</div>`;
            }

            if (s.family) {
                if (s.family.relation) {
                    html += `<div><b>Í∞ÄÏ°± Í¥ÄÍ≥Ñ</b> : ${s.family.relation}</div>`;
                }
                if (s.family.note) {
                    html += `<div><b>Î∞∞Í≤Ω ÏÑúÏà†</b> : ${s.family.note}</div>`;
                }
            }

            if (s.admission) {
                html += `<div><b>ÏàòÏö© Í≤ΩÏúÑ</b> : ${s.admission}</div>`;
            }

            if (!html) {
                html = `<div>Ï∂îÍ∞Ä ÌîÑÎ°úÌïÑ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</div>`;
            }

            subjectDetail.innerHTML = `
    <div style="font-size:11px; line-height:1.5">
      <div style="
        text-transform:uppercase;
        letter-spacing:.16em;
        font-size:10px;
        color:var(--muted);
        margin-bottom:4px;
      ">
        DETAIL // PROFILE
      </div>
      ${html}
    </div>
  `;
            subjectDetail.classList.remove('hidden');
        }


        // ====== Îßµ ÏúÑ Î∏îÎ¶Ω Î†åÎçîÎßÅ ======
        function renderBlips() {
            if (!cityContent) return;
            Array.from(cityContent.querySelectorAll('.blip')).forEach(e => e.remove());
            blipEls.clear();

            subjects.forEach((s, i) => {
                const el = document.createElement('div');
                el.className = 'blip ' + s.status;

                const seedX = 10 + (i * 19) % 78;
                const seedY = 12 + (i * 23) % 76;
                el.style.left = seedX + '%';
                el.style.top = seedY + '%';

                el.innerHTML = `<div class="p"></div>`;
                el.title = s.name;

                el.addEventListener('click', (ev) => {
                    selectSubject(s);
                    showMini(ev.clientX, ev.clientY, s);
                    ripple3(el);
                });

                cityContent.appendChild(el);
                blipEls.set(s.id, el);
            });
        }

        // ÏÑ†ÌÉùÎêú ÎåÄÏÉÅ Í∏∞Ï§ÄÏúºÎ°ú ÎØ∏Îãà Ïπ¥Îìú ÎùÑÏö∞Í∏∞
        function pingMini(s) {
            const el = blipEls.get(s.id);
            if (!el) return;
            const r = el.getBoundingClientRect();
            const cx = r.left + r.width / 2;
            const cy = r.top + r.height / 2;
            showMini(cx, cy, s);
            ripple3(el);
        }

        function showMini(x, y, s) {
            if (miniEl) miniEl.remove();
            miniEl = document.createElement('div');
            miniEl.className = 'mini';
            miniEl.innerHTML = `
      <h4>${s.name}</h4>
      <div>ÏÉÅÌÉú: ${statusMap[s.status].label}</div>
      <div>Îä•Î†•: ${s.ability}</div>
      <small>ÎßàÏßÄÎßâ Í∞±Ïã† ¬∑ ${timeAgo(s.updatedAt)}</small>
    `;

            const mapRect = document.querySelector('.map-inner').getBoundingClientRect();
            const nx = Math.min(mapRect.right - 220, Math.max(mapRect.left + 10, x + 12));
            const ny = Math.min(mapRect.bottom - 120, Math.max(mapRect.top + 10, y - 10));
            miniEl.style.left = nx + 'px';
            miniEl.style.top = ny + 'px';

            document.body.appendChild(miniEl);

            setTimeout(() => {
                if (miniEl) {
                    miniEl.remove();
                    miniEl = null;
                }
            }, 3200);
        }

        // Ï†êÏóêÏÑú ÌååÎèô 3Î≤à ÌçºÏßÄÎäî Ïï†ÎãàÎ©îÏù¥ÏÖò
        function ripple3(el) {
            const make = (delay) => {
                const ring = document.createElement('div');
                ring.style.position = 'absolute';
                ring.style.left = '-18px';
                ring.style.top = '-18px';
                ring.style.width = '48px';
                ring.style.height = '48px';
                ring.style.border = '2px solid rgba(0,245,255,.7)';
                ring.style.borderRadius = '50%';
                ring.style.opacity = '0.9';
                ring.style.pointerEvents = 'none';
                ring.style.filter = 'drop-shadow(0 0 8px rgba(0,245,255,.6))';

                ring.animate(
                    [
                        { transform: 'scale(0.4)', opacity: 0.9 },
                        { transform: 'scale(2.1)', opacity: 0 }
                    ],
                    { duration: 1200, delay: delay, easing: 'ease-out' }
                ).onfinish = () => ring.remove();

                el.appendChild(ring);
            };
            make(0); make(180); make(360);
        }

        // ===== UNLOCK INPUT Ïó∞Îèô =====
        const unlockInput = document.getElementById('unlockInput');
        const btnUnlock = document.getElementById('btnUnlock');

        if (btnUnlock && unlockInput) {
            btnUnlock.addEventListener('click', () => {
                const v = unlockInput.value;
                if (!v.trim()) return;
                unlockByCode(v);
                unlockInput.value = "";
            });
            unlockInput.addEventListener('keydown', (e) => {
                if (e.key === "Enter") {
                    btnUnlock.click();
                }
            });
        }

        // ===== Mini map wave init (Ï∫îÎ≤ÑÏä§ ÏóÜÏúºÎ©¥ ÏûêÎèô Ïä§ÌÇµ) =====
        (function () {
            const canvas = document.getElementById('wave');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            function resize() {
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
            }

            resize();
            const ro = new ResizeObserver(resize);
            ro.observe(canvas.parentElement);

            let t = 0;
            function draw() {
                const w = canvas.width, h = canvas.height;
                ctx.clearRect(0, 0, w, h);
                ctx.globalAlpha = 0.9;
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'rgba(126,249,255,.9)';
                ctx.beginPath();
                for (let x = 0; x < w; x += 3) {
                    const y = h * 0.5
                        + Math.sin((x + t) / 42) * 10
                        + Math.cos((x + t) / 17) * 6;
                    if (x === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.stroke();
                t += 2;
                requestAnimationFrame(draw);
            }
            requestAnimationFrame(draw);
        })();
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // ÏßÄÏù∏ Firebase ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ï
        const firebaseConfig = {
            apiKey: "AIzaSyBX9EghLLhQPFUxDxGgVbe-6VjSva-r2vQ",
            authDomain: "nacm-2041e.firebaseapp.com",
            projectId: "nacm-2041e",
            storageBucket: "nacm-2041e.firebasestorage.app",
            messagingSenderId: "90299682381",
            appId: "1:90299682381:web:d39afbc694314c12765604"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ÌòÑÏû¨ Ïú†Ï†Ä Í∞ÄÏ†∏Ïò§Í∏∞ (ÏóÜÏúºÎ©¥ ÏùµÎ™Ö Î°úÍ∑∏Ïù∏)
        async function getUser() {
            if (auth.currentUser) return auth.currentUser;
            const { user } = await signInAnonymously(auth);
            return user;
        }

        // üîπ 1) FirestoreÏóêÏÑú unlock ÏÉÅÌÉú Î∂àÎü¨Ïò§Í∏∞
        async function fetchUnlocks() {
            const user = await getUser();
            const ref = doc(db, "users", user.uid, "meta", "unlocks");
            const snap = await getDoc(ref);

            if (snap.exists()) {
                const data = snap.data();
                console.log("Î∂àÎü¨Ïò® unlock ÏÉÅÌÉú:", data);
                if (window.applyStoredUnlocks) {
                    window.applyStoredUnlocks(data);   // Î©îÏù∏ Ïä§ÌÅ¨Î¶ΩÌä∏Î°ú Ï†ÑÎã¨
                }
            } else {
                // Ï†ÄÏû•Îêú Í≤å ÏóÜÏúºÎ©¥ null Ï†ÑÎã¨Ìï¥ÏÑú Í∏∞Î≥∏ Î†åÎçîÎßÅÎßå
                if (window.applyStoredUnlocks) {
                    window.applyStoredUnlocks(null);
                }
            }
        }

        // üîπ 2) FirestoreÏóê unlock ÏÉÅÌÉú Ï†ÄÏû•
        async function saveUnlockState(subjectId) {
            const user = await getUser();
            const ref = doc(db, "users", user.uid, "meta", "unlocks");
            await setDoc(ref, { [subjectId]: true }, { merge: true });
            console.log("unlock Ï†ÄÏû• ÏôÑÎ£å:", subjectId);
        }

        // Î©îÏù∏ JSÏóêÏÑú Ìò∏Ï∂úÌïòÎäî ÌõÖ Ïó∞Í≤∞
        window.requestUnlockSync = function () {
            fetchUnlocks().catch(err => {
                console.error("unlock Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:", err);
                if (window.applyStoredUnlocks) {
                    window.applyStoredUnlocks(null);
                }
            });
        };

        window.saveUnlockState = function (subjectId) {
            saveUnlockState(subjectId).catch(err => {
                console.error("unlock Ï†ÄÏû• Ïã§Ìå®:", err);
            });
        };
    </script>


    <div class="toast" id="toast"></div>
</body>

</html>