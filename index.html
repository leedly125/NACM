<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <title>NACM // SUBJECT CONSOLE</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <style>
        :root {
            --bg: #02040a;
            --fg: #f5f7ff;
            --accent: #00eaf2;
            --accent-soft: rgba(0, 234, 242, .16);
            --card: #070b14;
            --border: rgba(255, 255, 255, .06);
            --muted: #8f9ab4;
            --danger: #ff4b6a;
            --warn: #ffb74b;
            --ok: #53ffa8;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        html,
        body {
            height: 100%
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background:
                radial-gradient(circle at 0 0, rgba(0, 234, 242, .12), transparent 55%),
                radial-gradient(circle at 100% 100%, rgba(137, 76, 255, .18), transparent 55%),
                #02040a;
            color: var(--fg);
            overflow: hidden;
        }

        a {
            color: var(--accent);
            text-decoration: none
        }

        a:hover {
            text-decoration: underline
        }

        button,
        input,
        select {
            font: inherit
        }

        /* HEADER */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 14px;
            background: linear-gradient(90deg, rgba(0, 0, 0, .9), rgba(0, 0, 0, .75));
            border-bottom: 1px solid rgba(255, 255, 255, .1);
            z-index: 10;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            letter-spacing: .14em;
            text-transform: uppercase;
            color: var(--muted);
        }

        .brand span {
            font-weight: 600;
            color: var(--accent);
        }

        .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .3);
            text-transform: uppercase;
            letter-spacing: .16em;
            color: var(--muted);
        }

        main {
            position: absolute;
            inset: 34px 0 0 0;
            display: flex;
            align-items: stretch;
            justify-content: center;
            padding: 16px;
        }

        .shell {
            width: 100%;
            max-width: 1120px;
            height: 100%;
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, .2);
            background:
                radial-gradient(circle at 0 0, rgba(0, 234, 242, .22), transparent 55%),
                linear-gradient(135deg, rgba(5, 10, 24, .98), rgba(3, 6, 14, .98));
            box-shadow:
                0 20px 40px rgba(0, 0, 0, .7),
                0 0 0 1px rgba(255, 255, 255, .06) inset;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }

        .shell-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--muted);
        }

        .crumbs {
            text-transform: uppercase;
            letter-spacing: .18em;
            font-size: 11px;
        }

        .crumbs span {
            color: var(--accent);
        }

        .chip-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .chip {
            padding: 3px 7px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .1);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: .12em;
            color: var(--muted);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .chip b {
            color: var(--accent);
            font-weight: 600
        }

        .chip.danger {
            border-color: rgba(255, 75, 106, .7);
            color: var(--danger)
        }

        .chip.danger b {
            color: var(--danger)
        }

        .chip.ok {
            border-color: rgba(83, 255, 168, .7);
            color: var(--ok)
        }

        .chip.ok b {
            color: var(--ok)
        }

        section {
            flex: 1;
            display: flex;
            gap: 12px;
            overflow: hidden;
        }

        .panel {
            background: radial-gradient(circle at 0 0, rgba(255, 255, 255, .03), transparent 55%), #040713;
            border-radius: 14px;
            border: 1px solid var(--border);
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .panel h2,
        .panel h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: .18em;
            color: var(--muted);
        }

        .leftcol {
            flex: 0 0 40%;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 0;
        }

        .rightcol {
            flex: 0 0 60%;
            min-width: 0;
        }

        /* LOGIN PANEL */
        #login {
            flex: 1;
            align-items: center;
            justify-content: center;
        }

        .login-inner {
            max-width: 360px;
            margin: 0 auto;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .login-title {
            font-size: 17px;
            text-transform: uppercase;
            letter-spacing: .18em;
            color: var(--muted);
        }

        .login-title span {
            color: var(--accent);
            font-weight: 600;
        }

        .kv {
            display: grid;
            grid-template-columns: auto 1fr;
            column-gap: 12px;
            row-gap: 4px;
            font-size: 12px;
            align-items: center;
        }

        .kv b {
            font-weight: 500;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .12em;
            font-size: 10px;
        }

        .kv input {
            border-radius: 999px;
            border: 1px solid var(--border);
            padding: 4px 8px;
            background: #03040a;
            color: var(--fg);
        }

        .btn {
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .28);
            background: linear-gradient(135deg, rgba(0, 234, 242, .18), rgba(0, 234, 242, .02));
            color: var(--fg);
            font-size: 11px;
            letter-spacing: .14em;
            text-transform: uppercase;
            padding: 6px 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(0, 234, 242, .3);
        }

        .btn.small {
            padding: 4px 10px;
            font-size: 10px
        }

        .muted {
            color: var(--muted);
            font-size: 11px
        }

        .hidden {
            display: none !important
        }

        .more-btn {
            padding-inline: 8px;
            font-size: 9px;
        }


        /* SUBJECT TABLE */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        th,
        td {
            padding: 6px 4px;
            border-bottom: 1px dashed rgba(255, 255, 255, .06);
            text-align: left;
        }

        th {
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: .12em;
            color: var(--muted);
            font-size: 10px;
        }

        tbody tr {
            cursor: pointer;
            transition: background .14s ease, border-color .14s ease;
        }

        tbody tr:hover {
            background: rgba(0, 234, 242, .07);
            border-color: rgba(0, 234, 242, .4);
        }

        tbody tr td:first-child strong {
            font-size: 12px;
        }

        .statusDot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 999px;
            margin-right: 4px;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, .8);
        }

        .s-green {
            background: var(--ok)
        }

        .s-yellow {
            background: var(--warn)
        }

        .s-red {
            background: var(--danger)
        }

        .s-gray {
            background: #777
        }

        /* DOSSIER + MAP HUD */
        .dossier {
            display: flex;
            flex-direction: column;
            gap: 8px;
            height: 100%;
        }

        .dossier h3 {
            margin-bottom: 2px;
        }

        #subjectInfo {
            font-size: 11px;
            padding: 6px 8px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, .08);
            background: rgba(0, 0, 0, .25);
        }

        .dossier .map-inner {
            position: relative;
            margin-top: 6px;
            display: grid;
            grid-template-columns: 1fr;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, .06);
            background: #05070b;
            min-height: 240px;
        }

        .dossier .city {
            position: relative;
            overflow: hidden;
            min-height: 100%;
            --camX: 0px;
            --camY: 0px;
            --bgx: 0px;
            --bgy: 0px;
        }

        .dossier .cityContent {
            position: absolute;
            inset: 0;
            transform: translate(var(--camX), var(--camY));
            will-change: transform;
        }

        .dossier .city::before {
            content: "";
            position: absolute;
            inset: 0;
            background:
                linear-gradient(90deg, rgba(0, 245, 255, .12) 1px, transparent 1px) var(--bgx) var(--bgy)/32px 32px,
                linear-gradient(0deg, rgba(0, 245, 255, .12) 1px, transparent 1px) var(--bgx) var(--bgy)/32px 32px,
                radial-gradient(circle at 40% 60%, rgba(0, 245, 255, .06), transparent 40%),
                radial-gradient(circle at 70% 30%, rgba(0, 245, 255, .05), transparent 40%),
                linear-gradient(180deg, #071018 0%, #060b12 60%, #05080e 100%);
            filter: contrast(120%);
        }

        .dossier .datastream {
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(90deg,
                    rgba(0, 245, 255, .05) 0 2px,
                    transparent 2px 6px);
            background-size: 200% 100%;
            animation: flow 6s linear infinite;
            mix-blend-mode: screen;
            pointer-events: none;
        }

        .dossier .radar {
            position: absolute;
            inset: -30%;
            background: conic-gradient(from var(--a), rgba(0, 245, 255, .22), transparent 35%);
            mix-blend-mode: screen;
            filter: blur(10px);
            animation: radar 7s linear infinite;
        }

        .dossier .rightHud {
            border-left: 1px solid rgba(255, 255, 255, .06);
            background: linear-gradient(180deg, rgba(255, 255, 255, .02), transparent);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: hidden;
        }

        .dossier .rightHud h3 {
            font-size: 11px;
            letter-spacing: .16em;
            color: var(--muted);
            text-transform: uppercase;
        }

        .dossier .streamBox {
            height: 100px;
            border: 1px solid rgba(255, 255, 255, .06);
            border-radius: 10px;
            position: relative;
            background: rgba(0, 0, 0, .3);
            overflow: hidden;
        }

        .dossier #wave {
            position: absolute;
            inset: 0;
        }

        .dossier .streamGlow {
            position: absolute;
            inset: 0;
            background: radial-gradient(600px 240px at 20% 40%, rgba(0, 245, 255, .12), transparent 60%);
            mix-blend-mode: screen;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            font-size: 11px;
        }

        .hud {
            font-size: 11px;
            color: #8fa0b6;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, .06);
            padding: 6px 8px;
            min-height: 38px;
        }

        .logs {
            margin-top: 6px;
            max-height: 34dvh;
            overflow: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 11px;
        }

        .log {
            font-family: ui-monospace, Consolas, monospace;
            font-size: 11px;
            color: #8fd9ef;
            background: rgba(0, 0, 0, .35);
            border: 1px solid rgba(255, 255, 255, .06);
            border-radius: 8px;
            padding: 4px 6px;
        }

        /* === ë§µ ìœ„ ë¸”ë¦½ + ë¯¸ë‹ˆ ì¹´ë“œ (index2 ìŠ¤íƒ€ì¼) === */
        /* <<< ì¶”ê°€ */
        .dossier .blip {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            pointer-events: auto;
        }

        .dossier .blip .p {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 10px var(--accent), 0 0 18px rgba(0, 245, 255, .45);
        }

        .dossier .blip.monitoring .p {
            background: var(--ok);
            box-shadow: 0 0 10px var(--ok), 0 0 18px rgba(83, 255, 168, .45);
        }

        .dossier .blip.missing .p {
            background: var(--danger);
            box-shadow: 0 0 10px var(--danger), 0 0 20px rgba(255, 75, 106, .5);
        }

        .dossier .blip.unknown .p {
            background: #8892a0;
            box-shadow: 0 0 8px #8892a0, 0 0 14px rgba(136, 146, 160, .4);
        }

        .mini {
            /* ê³ ì • ìœ„ì¹˜ ì‘ì€ ì •ë³´ì°½ */
            /* <<< ì¶”ê°€ */
            position: fixed;
            min-width: 180px;
            max-width: 240px;
            background: rgba(4, 8, 12, .94);
            border: 1px solid rgba(0, 245, 255, .3);
            box-shadow: 0 14px 28px rgba(0, 0, 0, .7);
            border-radius: 10px;
            padding: 8px 10px;
            font-size: 11px;
            color: #a9e9ff;
            z-index: 50;
        }

        .mini h4 {
            margin: 0 0 4px;
            color: #bffaff;
            font-size: 11px;
        }

        .mini small {
            color: var(--muted);
            display: block;
            margin-top: 2px;
        }

        /* TOAST */
        .toast {
            position: fixed;
            left: 50%;
            bottom: 18px;
            transform: translateX(-50%) translateY(100%);
            padding: 6px 14px;
            border-radius: 999px;
            border: 1px solid rgba(0, 234, 242, .7);
            background: rgba(2, 8, 18, .96);
            font-size: 11px;
            letter-spacing: .12em;
            text-transform: uppercase;
            color: var(--accent);
            opacity: 0;
            pointer-events: none;
            transition: transform .25s ease, opacity .25s ease;
            z-index: 40;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        @keyframes flow {
            to {
                background-position: -200% 0
            }
        }

        @keyframes radar {
            to {
                transform: rotate(360deg)
            }
        }

        @media (max-width:900px) {
            main {
                padding: 8px;
                position: static;
                /* â† ì¶”ê°€ */
                inset: auto;
                /* â† ì¶”ê°€ */
                height: auto;
                /* â† ì¶”ê°€ */
            }


            .shell {
                padding: 10px;
                height: auto;
                /* â† ì¶”ê°€ */
            }

            section {
                flex-direction: column;
                overflow: visible;
                /* â† ì¶”ê°€ */
            }

            .leftcol,
            .rightcol {
                flex: none;
                /* â† ê¸°ì¡´ flex:1 ì œê±° ì¶”ì²œ */
                width: 100%;
                /* â† ëª¨ë°”ì¼ìš©ìœ¼ë¡œ í™•ì¥ */
            }

            body {
                overflow: auto
            }
        }

        /* ============================================================
    MOBILE OPTIMIZATION PATCH // NACM CONSOLE (ì—°ì œ ì œì‘)
    í™”ë©´í­ 768px ì´í•˜ â†’ ëª¨ë°”ì¼ ì „ìš© UI
============================================================ */
        @media (max-width: 768px) {

            /* ì „ì²´ ìŠ¤í¬ë¡¤ naturally */
            html,
            body {
                height: auto;
                overflow: auto;
            }

            /* í—¤ë” ë” ì–‡ê²Œ + ê¸€ì ì¤„ì´ê¸° */
            header {
                height: 30px;
                padding: 0 10px;
                font-size: 11px;
            }

            .brand {
                font-size: 11px;
                gap: 4px;
            }

            .badge {
                font-size: 9px;
                padding: 1px 4px;
            }

            /* ë©”ì¸ íŒ¨ë”© ì¤„ì´ê¸° */
            main {
                position: static;
                inset: auto;
                height: auto;
            }

            /* ì‰˜ ê°€ë¡œ í­ ê½‰ ì°¨ê²Œ */
            .shell {
                height: auto;
            }

            /* header ë¶€ë¶„ ì¤„ì´ê¸° */
            .shell-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                font-size: 10px;
            }

            .crumbs {
                font-size: 10px;
            }

            .chip-row {
                gap: 4px;
            }

            /* ë ˆì´ì•„ì›ƒ â†’ ì„¸ë¡œ 1ì—´ */
            section {
                overflow: visible;
            }

            .leftcol,
            .rightcol {
                flex: none;
                width: 100%;
            }

            /* PANEL ê¸°ë³¸ íŒ¨ë”© ì¤„ì´ê¸° */
            .panel {
                padding: 8px 10px;
                border-radius: 10px;
                gap: 6px;
            }

            /* í…ìŠ¤íŠ¸ ì‘ì€ í™”ë©´ì—ì„œ ê°€ë…ì„± ìœ ì§€ */
            table {
                font-size: 10px;
            }

            th {
                font-size: 9px;
            }

            td {
                font-size: 10px;
                padding: 5px 3px;
            }

            /* ìƒíƒœì  í¬ê¸° ì‚´ì§ ì¤„ì´ê¸° */
            .statusDot {
                width: 7px;
                height: 7px;
                margin-right: 3px;
            }

            /* ìƒì„¸ ì •ë³´ Â· Unlock ì…ë ¥ì¹¸ Â· HUD ëª¨ë‘ í­ 100% */
            #subjectInfo,
            #unlockBox,
            .hud {
                width: 100%;
                font-size: 10px;
                padding: 6px;
            }

            /* ë¯¸ë‹ˆë§µ / city ì˜ì—­ ë†’ì´ ì¤„ì´ê¸° */
            .map-inner {
                min-height: 180px;
            }

            /* radar / datastream ì• ë‹ˆë©”ì´ì…˜ ê°•ë„ ê°ì†Œ (ëª¨ë°”ì¼ ë¶€í•˜ ë°©ì§€) */
            .dossier .radar {
                filter: blur(6px);
            }

            /* logs ê¸¸ì´ ì¡°ì ˆ */
            .logs {
                max-height: 24dvh;
                font-size: 10px;
            }

            /* MINI ì¹´ë“œ ëª¨ë°”ì¼ì—ì„œëŠ” í™”ë©´ ë°–ìœ¼ë¡œ ì•ˆ ë‚˜ê°€ê²Œ */
            .mini {
                max-width: 180px;
                font-size: 10px;
                padding: 6px 8px;
            }

            /* ë²„íŠ¼ í¬ê¸° ì¤„ì´ê¸° */
            .btn {
                font-size: 10px;
                padding: 5px 10px;
            }

            .btn.small {
                padding: 4px 8px;
                font-size: 9px;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="brand">
            <span>NACM</span>
            <div>êµ­ê°€ëŠ¥ë ¥ê°œë°œë°ê´€ë¦¬ì› // OBSERVER NODE</div>
        </div>
        <div class="badge">INTERNAL // LEVEL 3</div>
    </header>

    <main>
        <div class="shell">
            <div class="shell-header">
                <div class="crumbs">
                    NACM // <span>SUBJECT LINK CONSOLE</span>
                </div>
                <div class="chip-row">
                    <div class="chip"><b>ZONE</b> S-03 // METRO</div>
                    <div class="chip danger"><b>ALERT</b> PATTERN MATCH 2Y AGO</div>
                    <div class="chip ok"><b>STATUS</b> LINK STANDBY</div>
                </div>
            </div>

            <!-- LOGIN -->
            <section id="login" class="panel">
                <div class="login-inner">
                    <div class="login-title">
                        NACM LINK // <span>AGENT AUTH</span>
                    </div>
                    <p class="muted">
                        í˜„ì¥ ìš”ì› ì¸ì¦ í›„, ê³ ìœ„í—˜ ì´ˆëŠ¥ë ¥ì ê´€ì°° ì½˜ì†”ì— ì ‘ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        ì¸ì¦ ì •ë³´ëŠ” ë‚´ë¶€ ë§ì„ í†µí•´ ì•”í˜¸í™” ì „ì†¡ë©ë‹ˆë‹¤.
                    </p>
                    <div class="kv" style="margin-top:6px">
                        <b>Agent ID</b>
                        <div><input type="text" value="E-3 / FIELD" disabled></div>
                        <b>Zone</b>
                        <div><input type="text" value="ì„œìš¸ê¶Œì—­ S-03" disabled></div>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;margin-top:8px">
                        <button class="btn" id="btnAuth">
                            LINK AUTH
                        </button>
                        <span class="muted">ì¸ì¦ í›„ ëŒ€ìƒ ë¦¬ìŠ¤íŠ¸ê°€ í™œì„±í™”ë©ë‹ˆë‹¤.</span>
                    </div>
                </div>
            </section>

            <!-- CONSOLE -->
            <section id="console" class="hidden">
                <div class="leftcol">
                    <div class="panel">
                        <h3>SUBJECT // INDEX</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>NAME</th>
                                    <th>STATE</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="tbody"></tbody>
                        </table>
                        <div class="muted" style="margin-top:4px">
                            Â· í´ë¦­ ì‹œ ëŒ€ìƒ ìƒì„¸ + ë§í¬ HUD ë™ê¸°í™”
                        </div>
                    </div>
                </div>

                <div class="rightcol">
                    <div class="panel dossier" id="dossier">
                        <h3>SELECTED // SUBJECT</h3>

                        <!-- ì„ íƒëœ ì¸ë¬¼ ì •ë³´ -->
                        <div id="subjectInfo" class="kv">
                            <b>ì´ë¦„</b>
                            <div>â€”</div>
                            <b>ìƒíƒœ</b>
                            <div>â€”</div>
                            <b>ëŠ¥ë ¥</b>
                            <div>â€”</div>
                            <b>ë©”ëª¨</b>
                            <div>ì™¼ìª½ ëª©ë¡ì—ì„œ ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”.</div>
                            <b>ë§ˆì§€ë§‰ ê°±ì‹ </b>
                            <div>â€”</div>
                        </div>

                        <div id="subjectDetail" class="hud hidden" style="margin-top:6px;">
                            <!-- More ë²„íŠ¼ ëˆŒë €ì„ ë•Œ ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ë¡œ ë“¤ì–´ê° -->
                        </div>

                        <div class="kv" id="unlockBox" style="margin-top:6px">
                            <b>UNLOCK</b>
                            <div style="display:flex;gap:4px;align-items:center;">
                                <input id="unlockInput" type="password" placeholder="ì½”ë“œ ì…ë ¥" style="flex:1;min-width:0;">
                                <button class="btn small" id="btnUnlock">OK</button>
                            </div>
                        </div>

                        <!-- Mini Map HUD -->
                        <div class="map-inner">
                            <div class="city" id="cityView">
                                <div class="cityContent">
                                    <div class="datastream"></div>
                                    <div class="radar"></div>
                                    <!-- blips injected here -->
                                </div>
                            </div>
                        </div>
                        <!-- ë¡œê·¸ -->
                        <div class="logs" id="logs"></div>
                    </div>
            </section>
        </div>
    </main>



    <script>
        // ===== Helpers =====
        function timeAgo(d) {
            if (!(d instanceof Date)) d = new Date(d);
            const sec = Math.floor((Date.now() - d.getTime()) / 1000);
            if (sec < 60) return sec + "s ì „";
            const m = Math.floor(sec / 60);
            if (m < 60) return m + "m ì „";
            const h = Math.floor(m / 60);
            if (h < 24) return h + "h ì „";
            const dd = Math.floor(h / 24);
            return dd + "d ì „";
        }
        function ago(sec) {
            return new Date(Date.now() - sec * 1000);
        }

        function banner(msg) {
            const b = document.getElementById('toast');
            if (!b) return;
            b.textContent = msg;
            b.classList.add('show');
            setTimeout(() => b.classList.remove('show'), 1600);
        }

        function log(msg) {
            const logs = document.getElementById('logs');
            if (!logs) return;
            const el = document.createElement('div');
            el.className = 'log';
            const t = new Date();
            const hh = String(t.getHours()).padStart(2, '0');
            const mm = String(t.getMinutes()).padStart(2, '0');
            el.textContent = `[${hh}:${mm}] ${msg}`;
            logs.prepend(el);
            while (logs.children.length > 60) {
                logs.lastChild.remove();
            }
        }

        // ===== Data : 2ë…„ ì „ ê¸°ì¤€ LOCKED ìƒíƒœ ê¸°ë¡ =====
        const subjects = [
            { id: 'khw', name: 'ê°•í˜„ìš°', status: 'locked', ability: 'ë¬¼ì§ˆë¶„í•´', note: '2ë…„ ì „ ìˆ˜ìš©ì†Œ ë¶•ê´´ ì§ì „, ì‹¤í—˜ë™ Bë™ ë§ˆì§€ë§‰ ê¸°ë¡.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'sjh', name: 'ì„œì§€í˜¸', status: 'locked', ability: 'ì‹œê°„ì¡°ì¢…', note: 'ë¶•ê´´ ì§€ì  ì¤‘ì‹¬ë¶€ ì¸ê·¼ì—ì„œ ë¹„ì •ìƒì ì¸ ì‹œê°„ ì™œê³¡ í¬ì°© í›„ ê¸°ë¡ ëŠê¹€.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'ldy', name: 'ì„ë„ìœ¤', status: 'locked', ability: 'ì •ì‹ ì§€ë°°', note: 'ê´€ì°° ë¡œê·¸ ë‹¤ìˆ˜ ì‚­ì œ. 2ë…„ ì „ ê¸°ë¡ ê¸°ì¤€, ì •ì‹  ê°œì… ì˜ì‹¬.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'cjk', name: 'ìµœì¤€í˜', status: 'locked', ability: 'ì •ë³´ì¡°ì‘', note: 'ì¶œì…ê¸°ë¡ ë° CCTV ë¡œê·¸ ì¡°ì‘ í”ì . ë¶•ê´´ ë‹¹ì¼ í–‰ì  ë¶ˆëª….', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'ktj', name: 'ê¹€íƒœì¤€', status: 'locked', ability: 'ì¤‘ë ¥ì¡°ì‘', note: 'ìˆ˜ìš©êµ¬ì—­ ì „ì²´ ì¤‘ë ¥ ë³€ë™ì˜ ì¤‘ì‹¬. ê²©ë¦¬ ì§ì „ê¹Œì§€ ê³¼ë¶€í•˜ ìƒíƒœ.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'lmw', name: 'ì´ë¯¼ìš°', status: 'locked', ability: 'ë…ì„±ë³€í™˜', note: 'ë…ì„± êµ¬ì—­ ìœ ì¶œ ì‚¬ê³  ì´í›„, ë³„ë„ ë…ë¦½ êµ¬ì—­ìœ¼ë¡œ ê²©ë¦¬.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'yhj', name: 'ìœ¤í•˜ì§„', status: 'locked', ability: 'ì—ë„ˆì§€í­ë°œ', note: 'ë¶•ê´´ ì§€ì  ì—ë„ˆì§€ í­ì‹¬ì§€. ì´í›„ ê¸°ë¡ ì—†ìŒ.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'lsh', name: 'ì´ìˆ˜í˜¸', status: 'locked', ability: 'ê¸°ì–µì¡°ì‘', note: 'ê´€ì°° ì¸ë ¥ë“¤ì˜ ê¸°ì–µ ê³µë°± ë‹¤ìˆ˜ ë³´ê³ . ê³µì‹ ê¸°ë¡ê³¼ ì§„ìˆ  ë¶ˆì¼ì¹˜.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'cmg', name: 'ì²œë¯¼ê²°', status: 'locked', ability: 'ë¬¼ë¦¬ê°•í™”', note: '2ë…„ ì „ ìˆ˜ìš©ì†Œ ë¶•ê´´ ë‹¹ì‹œ, ì™¸ë¶€ ëŒ€ê¸°ì¡° ì¸ê·¼ì—ì„œ ë§ˆì§€ë§‰ í¬ì°©.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'gjw', name: 'ê°•ì§€ì›', status: 'locked', ability: 'ì‹ ì²´ì¬ìƒ', note: 'ì¤‘ìƒ ì…ì—ˆìŒì—ë„ ìƒì¡´. ì´í›„ ë…ë¦½ ê²©ë¦¬ì‹¤ë¡œ ì´ì†¡ ê¸°ë¡ í›„ ë°ì´í„° ëŠê¹€.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'osj', name: 'ì˜¤ì„¸ì¤€', status: 'locked', ability: 'ìƒì²´ì¡°ì‘', note: 'ë¶•ê´´ ì§ì „, ì‹¤í—˜ì²´ ë‹¤ìˆ˜ì˜ ìƒì²´ ë°˜ì‘ ì´ìƒì¹˜ ë³´ê³ ë¨.', updatedAt: ago(60 * 60 * 24 * 730) },
            { id: 'jhs', name: 'ì •í˜„ìˆ˜', status: 'locked', ability: 'ì „ìê¸°íŒŒ', note: 'ê´€ì¸¡ ì¥ë¹„ ê³¼ë¶€í•˜ ìœ ë°œ. í†µì‹  ë¡œê·¸ ëŒ€ëŸ‰ ì†ì‹¤ì˜ ì›ì¸ìœ¼ë¡œ ì¶”ì •.', updatedAt: ago(60 * 60 * 24 * 730) }
        ];

        const statusMap = {
            monitoring: { label: 'Monitoring', dot: 's-green' },
            missing: { label: 'Missing', dot: 's-red' },
            unknown: { label: 'Unknown', dot: 's-gray' },
            locked: { label: 'Locked', dot: 's-yellow' }
        };

        // ===== Unlock ì´í›„ ì ìš©ë  "í˜„ì¬ ì •ë³´" í”„ë¡œí•„ =====
        const unlockProfiles = {
            khw: {
                status: "monitoring",
                ability: "ë¬¼ì§ˆë¶„í•´",
                note: "í˜„ì¬: ì™¸ë¶€ ë¹„ê³µê°œ ì‹œì„¤ì—ì„œ ì œí•œì  í˜‘ë ¥ ì¤‘. ë¬¼ì§ˆ ë¶„í•´ ëŠ¥ë ¥ì€ ì•ˆì •í™” í”„ë¡œí† ì½œ ì ìš© ìƒíƒœ."
            },
            sjh: {
                status: "monitoring",
                ability: "ì‹œê°„ì¡°ì¢…",
                note: "í˜„ì¬: ì‹œê°„ ì™œê³¡ ë²”ìœ„ ì¶•ì†Œ. ì˜ë„ì  ì‚¬ìš©ì— ëŒ€í•œ ìê°€ ë³´ê³ ê°€ ê°€ëŠ¥í•´ì§."
            },
            ldy: {
                status: "monitoring",
                ability: "ì •ì‹ ì§€ë°°",
                note: "í˜„ì¬: ì£¼ê¸°ì  ì‹¬ë¦¬ í‰ê°€ í•˜ì— ê´€ì°° ì¤‘. ê°•ì œ ê°œì…ë³´ë‹¤ â€˜ì„¤ë“â€™ì— ê°€ê¹Œìš´ ì‚¬ìš© íŒ¨í„´ì„ ë³´ì„."
            },
            cjk: {
                status: "monitoring",
                ability: "ì •ë³´ì¡°ì‘",
                note: "í˜„ì¬: ë°ì´í„° ìœ„ì¡° í”ì  ìì²´ë¥¼ ì¶”ì í•˜ê¸° ìœ„í•œ ë‚´ë¶€ ë„êµ¬ ì—­í• ë¡œ í™œìš© ì¤‘."
            },
            ktj: {
                status: "monitoring",
                ability: "ì¤‘ë ¥ì¡°ì‘",
                note: "í˜„ì¬: ì¤‘ë ¥ í•„ë“œ ì¡°ì ˆ ë²”ìœ„ê°€ ì•ˆì •í™” ë‹¨ê³„. ì‹¤ì „ íˆ¬ì… ê°€ëŠ¥ì„± ê²€í†  ì¤‘."
            },
            lmw: {
                status: "monitoring",
                ability: "ë…ì„±ë³€í™˜",
                note: "í˜„ì¬: ë…ì„± ë¬¼ì§ˆì„ ë¬´ë…ì„±ìœ¼ë¡œ ì „í™˜í•˜ëŠ” ë°©í–¥ì˜ í›ˆë ¨ì´ ì§„í–‰ ì¤‘."
            },
            yhj: {
                status: "monitoring",
                age: "30ì„¸",
                family: {
                    relation: "ë“±ë¡ëœ ê°€ì¡± ì—†ìŒ",
                    note: "ì¥ê¸°ê°„ ë‹¨ë… ìƒì¡´ ê¸°ë¡ì´ í™•ì¸ë¨."
                },
                ability: "ì—ë„ˆì§€ í­ë°œ",
                sideEffect: "ëŒ€ê·œëª¨ í­ë°œ í›„ ì²´ì˜¨ ì¡°ì ˆ ë¶ˆê°€ / ê·¹ì‹¬í•œ í”¼ë¡œ ë°œìƒ",
                lifestyle: {
                    substances: "ìˆ Â·ë‹´ë°°Â·ì•½ë¬¼ ëª¨ë‘ ì•ˆ í•¨"
                },
                psychology: {
                    tendency: "ìê·¹ì  íŒŒê´´ì™€ ìœ„í—˜ì„ í†µí•´ì„œë§Œ ì¡´ì¬ë¥¼ ì‹¤ê°í•˜ëŠ” ìê¸°íŒŒê´´ì  ì„±í–¥"
                },
                note: "í˜„ì¬: ì—ë„ˆì§€ ë°©ì¶œëŸ‰ ì¡°ì ˆ ê°€ëŠ¥. ë…ë¦½ì ìœ¼ë¡œ í™œë™ ì¤‘ì´ë©° ì¶”ì¢…ìë“¤ì´ ìˆìŒ."
            },
            lsh: {
                status: "monitoring",
                ability: "ê¸°ì–µì¡°ì‘",
                note: "í˜„ì¬: ì¦ì–¸ ë³´í˜¸ ë° ì‹ ì› ë³´í˜¸ ëª©ì ì˜ ì œí•œì  ì‚¬ìš© í—ˆê°€. ë‚¨ìš© ë°©ì§€ í”„ë¡œí† ì½œ ë™ì‹œ ìš´ìš©."
            },
            cmg: {
                status: "monitoring",
                age: "29ì„¸",
                family: {
                    relation: "7ë‚¨ë§¤ ì¤‘ ì²«ì§¸",
                    note: "ë¶€ëª¨ëŠ” ì‚¬ê³ ë¡œ ì‚¬ë§í–ˆìœ¼ë©°, ë‹¤ì„¯ì§¸ ë™ìƒì€ ê³¼ê±° ì€í–‰ ê°•ë„ ì‚¬ê±´ì˜ ê³„ê¸°ê°€ ëœ ì‚¬ê³ ë¡œ ì‚¬ë§í•¨."
                },
                ability: "ì‹ ì²´ì˜ ë¬¼ë¦¬ì  ê°•í™”",
                sideEffect: "ê³¼ë„í•œ ê°•í™” í›„ ê·¼ìœ¡ íŒŒì—´ê³¼ ë¯¸ì„¸ ê³¨ì ˆ",
                lifestyle: {
                    substances: "ê¸´ì¥í•  ë•Œ ì†í†±ì„ ë¬¼ì–´ëœ¯ê±°ë‚˜ ì… ì•ˆìª½ì„ ì”¹ëŠ” ìŠµê´€ì´ ìˆìœ¼ë©°, ì†ëª©ì‹œê³„ë¥¼ ìì£¼ ë§Œì§. ê¸¸ì¹˜ì´ì ê¸°ê³„ì¹˜."
                },
                psychology: {
                    tendency: "ì‚¬ê³  ë°©ì‹ì´ ë‹¨ìˆœí•˜ë©° ë³µì¡í•œ ìƒí™©ì„ ì‹«ì–´í•˜ê³ , ëŒ€ë¶€ë¶„ì˜ íŒë‹¨ì„ ì§ê°ì— ì˜ì¡´í•¨."
                },
                note: "í˜„ì¬: NACM ì†Œì† í˜„ì¥ ìš”ì›ìœ¼ë¡œ í™œë™ ì¤‘ì´ë©°, ìœ„í—˜ë„ê°€ ë†’ì€ ì„ë¬´ì— ìš°ì„  íˆ¬ì…ë˜ëŠ” ì „ë‹´ ìš”ì›."
            },
            gjw: {
                status: "monitoring",
                ability: "ì‹ ì²´ì¬ìƒ",
                
                note: "í˜„ì¬: ì¬ìƒ ëŠ¥ë ¥ì€ ì—¬ì „íˆ ê°•ë ¥í•˜ë‚˜, ê³¼ë„ ì‚¬ìš© ì‹œ í”¼ë¡œ ëˆ„ì  ë³´ê³ ë¨. ì§€ì› ìš”ì› ê²¸ ì‹¤í—˜ ëŒ€ìƒ."
            },
            osj: {
                status: "monitoring",
                ability: "ìƒì²´ì¡°ì‘",
                note: "í˜„ì¬: ì˜ë£Œ ì§€ì› ë° ì‘ê¸‰ ìƒí™©ì—ì„œì˜ ì œí•œì  ê°œì… í—ˆìš©. ë¹„ìœ¤ë¦¬ì  ì‹¤í—˜ì€ ì „ë©´ ê¸ˆì§€ ìƒíƒœ."
            },
            jhs: {
                status: "monitoring",
                ability: "ì „ìê¸°íŒŒ",
                note: "í˜„ì¬: í†µì‹  êµë€ ë° ì „ì ë°©ì–´ ì„ë¬´ì— íˆ¬ì…. ìì‹ ì˜ ëŠ¥ë ¥ìœ¼ë¡œ ìƒì–´ë²„ë¦° ê¸°ë¡ ë³µêµ¬ë¥¼ ì‹œë„ ì¤‘."
            }
        };

        // ===== Unlock Code Mapping (ìºë¦­í„°ë³„ í•´ì œ ì½”ë“œ) =====
        const unlockCodes = {
            "2702213418": "khw",
            "9803901542": "sjh",
            "1801132063": "ldy",
            "3703532255": "cjk",
            "3803602536": "ktj",
            "4703721828": "lmw",
            "3703472877": "yhj",
            "1701163169": "lsh",
            "2602054483": "cmg",
            "4504704271": "gjw",
            "4704713992": "osj",
            "3703413095": "jhs"
        };

        // ===== Firestoreì—ì„œ ë¶ˆëŸ¬ì˜¨ unlockì„ subjectsì— ë°˜ì˜í•˜ëŠ” í•¨ìˆ˜ =====
        function applyStoredUnlocks(unlockData) {
            if (!unlockData) {
                // ì €ì¥ëœ ê²Œ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ê¸°ë³¸ ëª©ë¡ë§Œ ê·¸ë¦¼
                renderTable();
                renderBlips();
                return;
            }

            subjects.forEach(s => {
                if (unlockData[s.id]) {
                    const profile = unlockProfiles[s.id];
                    if (profile) {
                        // í”„ë¡œí•„ì— ìˆëŠ” ê°’ë“¤ì„ í†µì§¸ë¡œ ë®ì–´ì“°ê¸° (status, ability, note, age, sideEffect ë“±)
                        Object.assign(s, profile);
                    } else {
                        s.status = "monitoring";
                        s.note = (s.note || "") + " // RESTORED";
                    }

                    s.updatedAt = new Date();
                }
            });

            renderTable();
            renderBlips();
        }

        // ëª¨ë“ˆ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì“¸ ìˆ˜ ìˆê²Œ windowì— ì˜¬ë ¤ë‘ê¸°
        window.applyStoredUnlocks = applyStoredUnlocks;

        function unlockByCode(code) {
            const clean = String(code || "").trim();
            if (!clean) {
                banner("CODE EMPTY");
                return false;
            }

            const targetId = unlockCodes[clean];
            if (!targetId) {
                banner("INVALID CODE");
                log("UNLOCK FAIL // CODE " + clean);
                return false;
            }

            const s = subjects.find(x => x.id === targetId);
            if (!s) {
                banner("NO SUBJECT");
                log("UNLOCK FAIL // SUBJECT NOT FOUND");
                return false;
            }

            // ì´ë¯¸ í’€ë ¤ ìˆìœ¼ë©´
            if (s.status !== "locked") {
                banner("ALREADY UNLOCKED");
                log("UNLOCK REDUNDANT // " + s.name);
                selectSubject(s);
                return true;
            }

            // ì—¬ê¸°ì„œ ì§„ì§œ í•´ì œ: 2ë…„ ì „ ê¸°ë¡ â†’ í˜„ì¬ í”„ë¡œí•„ë¡œ êµì²´
            const profile = unlockProfiles[targetId];

            if (profile) {
                Object.assign(s, profile);
            } else {
                s.status = "monitoring";
                s.note = (s.note || "") + " // CODE UNLOCKED";
            }

            s.updatedAt = new Date();

            // Firestoreì— ì €ì¥ ìš”ì²­ (ëª¨ë“ˆ ìŠ¤í¬ë¦½íŠ¸ê°€ ì²˜ë¦¬)
            if (window.saveUnlockState) {
                window.saveUnlockState(targetId);
            }

            renderTable();
            renderBlips();
            selectSubject(s);
            banner("LINK UNLOCKED");
            log("UNLOCK OK // " + s.name + " VIA CODE " + clean);
            return true;
        }

        // ===== DOM refs =====
        const loginSec = document.getElementById('login');
        const consoleSec = document.getElementById('console');
        const tbody = document.getElementById('tbody');
        const subjectInfo = document.getElementById('subjectInfo');
        const cityView = document.getElementById('cityView');
        const cityContent = cityView ? cityView.querySelector('.cityContent') : null;
        const subjectDetail = document.getElementById('subjectDetail');


        const blipEls = new Map();
        let miniEl = null;

        // ===== Auth click =====
        document.getElementById('btnAuth').addEventListener('click', () => {
            loginSec.style.transition = 'opacity .35s ease';
            loginSec.style.opacity = '0';
            setTimeout(() => {
                loginSec.classList.add('hidden');
                consoleSec.classList.remove('hidden');
                loginSec.style.opacity = '1';

                // ğŸ”¥ Firebase ëª¨ë“ˆì´ ìˆìœ¼ë©´ ê±°ê¸°ì„œ unlock ë¶ˆëŸ¬ì˜¤ë¼ê³  ìš”ì²­
                if (window.requestUnlockSync) {
                    window.requestUnlockSync();
                } else {
                    // Firebase ì—°ë™ ì „ì´ë¼ë©´ ê·¸ëƒ¥ ê¸°ë³¸ ë Œë”ë§
                    renderTable();
                    renderBlips();
                }

                banner('LINK ONLINE â€” SAT RELAY ACTIVE');
                log('LINK ONLINE // SUBJECT INDEX SYNC');
            }, 350);
        });

        // ===== Table render =====
        function renderTable() {
            tbody.innerHTML = '';
            subjects.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
      <td><strong>${s.name}</strong></td>
      <td><span class="statusDot ${statusMap[s.status].dot}"></span>${statusMap[s.status].label}</td>
      <td class="actions"></td>
    `;

                // í–‰ í´ë¦­ ì‹œ ê¸°ë³¸ ì„ íƒ
                tr.addEventListener('click', () => selectSubject(s));

                // More ë²„íŠ¼ (í•´ì œëœ ëŒ€ìƒë§Œ)
                const actionsTd = tr.querySelector('.actions');
                if (s.status !== 'locked') {
                    const btn = document.createElement('button');
                    btn.textContent = 'MORE';
                    btn.className = 'btn small more-btn';
                    btn.addEventListener('click', (ev) => {
                        ev.stopPropagation();      // í–‰ í´ë¦­ ì´ë²¤íŠ¸ë‘ ì•ˆ ì„ì´ê²Œ
                        selectSubject(s);          // HUDë„ ê°™ì´ ë™ê¸°í™”
                        showSubjectDetail(s);      // ìƒì„¸ ì •ë³´ ì—´ê¸°
                    });
                    actionsTd.appendChild(btn);
                }

                tbody.appendChild(tr);
            });
        }


        // ===== Subject select =====
        function selectSubject(s) {
            subjectInfo.innerHTML = `
      <b>ì´ë¦„</b><div><span class="statusDot ${statusMap[s.status].dot}"></span>${s.name}</div>
      <b>ìƒíƒœ</b><div>${statusMap[s.status].label}</div>
      <b>ëŠ¥ë ¥</b><div>${s.ability}</div>
      <b>ë©”ëª¨</b><div>${s.note || 'â€”'}</div>
      <b>ë§ˆì§€ë§‰ ê°±ì‹ </b><div class="timer" id="selTimer">${timeAgo(s.updatedAt)}</div>
    `;

            log(`[SELECT] ${s.name} â€” ${statusMap[s.status].label}`);
            pingMini(s);

            if (window.selTimerInt) clearInterval(window.selTimerInt);
            window.selTimerInt = setInterval(() => {
                const el = document.getElementById('selTimer');
                if (el) el.textContent = timeAgo(s.updatedAt);
            }, 1000);
            // ğŸ”¹ ì ê¸ˆ ëŒ€ìƒ ì„ íƒí•˜ë©´ ìƒì„¸ ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
            if (subjectDetail) {
                if (s.status === 'locked') {
                    subjectDetail.classList.add('hidden');
                    subjectDetail.innerHTML = '';
                }
            }
        }

        function showSubjectDetail(s) {
            if (!subjectDetail) return;

            if (s.status === 'locked') {
                subjectDetail.classList.add('hidden');
                subjectDetail.innerHTML = '';
                banner('LOCKED SUBJECT');
                return;
            }

            let html = '';

            if (s.age) {
                html += `<div><b>ì—°ë ¹</b> : ${s.age}</div>`;
            }
            if (s.sideEffect) {
                html += `<div><b>í›„ìœ ì¦</b> : ${s.sideEffect}</div>`;
            }
            if (s.lifestyle && s.lifestyle.substances) {
                html += `<div><b>ìƒí™œ ìŠµê´€</b> : ${s.lifestyle.substances}</div>`;
            }
            if (s.psychology && s.psychology.tendency) {
                html += `<div><b>ì„±í–¥</b> : ${s.psychology.tendency}</div>`;
            }

            if (s.family) {
                if (s.family.relation) {
                    html += `<div><b>ê°€ì¡± ê´€ê³„</b> : ${s.family.relation}</div>`;
                }
                if (s.family.note) {
                    html += `<div><b>ë¹„ê³ </b> : ${s.family.note}</div>`;
                }
            }


            if (!html) {
                html = `<div>ì¶”ê°€ í”„ë¡œí•„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }

            subjectDetail.innerHTML = `
    <div style="font-size:11px; line-height:1.5">
      <div style="
        text-transform:uppercase;
        letter-spacing:.16em;
        font-size:10px;
        color:var(--muted);
        margin-bottom:4px;
      ">
        DETAIL // PROFILE
      </div>
      ${html}
    </div>
  `;
            subjectDetail.classList.remove('hidden');
        }


        // ====== ë§µ ìœ„ ë¸”ë¦½ ë Œë”ë§ ======
        function renderBlips() {
            if (!cityContent) return;
            Array.from(cityContent.querySelectorAll('.blip')).forEach(e => e.remove());
            blipEls.clear();

            subjects.forEach((s, i) => {
                const el = document.createElement('div');
                el.className = 'blip ' + s.status;

                const seedX = 10 + (i * 19) % 78;
                const seedY = 12 + (i * 23) % 76;
                el.style.left = seedX + '%';
                el.style.top = seedY + '%';

                el.innerHTML = `<div class="p"></div>`;
                el.title = s.name;

                el.addEventListener('click', (ev) => {
                    selectSubject(s);
                    showMini(ev.clientX, ev.clientY, s);
                    ripple3(el);
                });

                cityContent.appendChild(el);
                blipEls.set(s.id, el);
            });
        }

        // ì„ íƒëœ ëŒ€ìƒ ê¸°ì¤€ìœ¼ë¡œ ë¯¸ë‹ˆ ì¹´ë“œ ë„ìš°ê¸°
        function pingMini(s) {
            const el = blipEls.get(s.id);
            if (!el) return;
            const r = el.getBoundingClientRect();
            const cx = r.left + r.width / 2;
            const cy = r.top + r.height / 2;
            showMini(cx, cy, s);
            ripple3(el);
        }

        function showMini(x, y, s) {
            if (miniEl) miniEl.remove();
            miniEl = document.createElement('div');
            miniEl.className = 'mini';
            miniEl.innerHTML = `
      <h4>${s.name}</h4>
      <div>ìƒíƒœ: ${statusMap[s.status].label}</div>
      <div>ëŠ¥ë ¥: ${s.ability}</div>
      <small>ë§ˆì§€ë§‰ ê°±ì‹  Â· ${timeAgo(s.updatedAt)}</small>
    `;

            const mapRect = document.querySelector('.map-inner').getBoundingClientRect();
            const nx = Math.min(mapRect.right - 220, Math.max(mapRect.left + 10, x + 12));
            const ny = Math.min(mapRect.bottom - 120, Math.max(mapRect.top + 10, y - 10));
            miniEl.style.left = nx + 'px';
            miniEl.style.top = ny + 'px';

            document.body.appendChild(miniEl);

            setTimeout(() => {
                if (miniEl) {
                    miniEl.remove();
                    miniEl = null;
                }
            }, 3200);
        }

        // ì ì—ì„œ íŒŒë™ 3ë²ˆ í¼ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜
        function ripple3(el) {
            const make = (delay) => {
                const ring = document.createElement('div');
                ring.style.position = 'absolute';
                ring.style.left = '-18px';
                ring.style.top = '-18px';
                ring.style.width = '48px';
                ring.style.height = '48px';
                ring.style.border = '2px solid rgba(0,245,255,.7)';
                ring.style.borderRadius = '50%';
                ring.style.opacity = '0.9';
                ring.style.pointerEvents = 'none';
                ring.style.filter = 'drop-shadow(0 0 8px rgba(0,245,255,.6))';

                ring.animate(
                    [
                        { transform: 'scale(0.4)', opacity: 0.9 },
                        { transform: 'scale(2.1)', opacity: 0 }
                    ],
                    { duration: 1200, delay: delay, easing: 'ease-out' }
                ).onfinish = () => ring.remove();

                el.appendChild(ring);
            };
            make(0); make(180); make(360);
        }

        // ===== UNLOCK INPUT ì—°ë™ =====
        const unlockInput = document.getElementById('unlockInput');
        const btnUnlock = document.getElementById('btnUnlock');

        if (btnUnlock && unlockInput) {
            btnUnlock.addEventListener('click', () => {
                const v = unlockInput.value;
                if (!v.trim()) return;
                unlockByCode(v);
                unlockInput.value = "";
            });
            unlockInput.addEventListener('keydown', (e) => {
                if (e.key === "Enter") {
                    btnUnlock.click();
                }
            });
        }

        // ===== Mini map wave init (ìº”ë²„ìŠ¤ ì—†ìœ¼ë©´ ìë™ ìŠ¤í‚µ) =====
        (function () {
            const canvas = document.getElementById('wave');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            function resize() {
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
            }

            resize();
            const ro = new ResizeObserver(resize);
            ro.observe(canvas.parentElement);

            let t = 0;
            function draw() {
                const w = canvas.width, h = canvas.height;
                ctx.clearRect(0, 0, w, h);
                ctx.globalAlpha = 0.9;
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'rgba(126,249,255,.9)';
                ctx.beginPath();
                for (let x = 0; x < w; x += 3) {
                    const y = h * 0.5
                        + Math.sin((x + t) / 42) * 10
                        + Math.cos((x + t) / 17) * 6;
                    if (x === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.stroke();
                t += 2;
                requestAnimationFrame(draw);
            }
            requestAnimationFrame(draw);
        })();
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // ì§€ì¸ Firebase í”„ë¡œì íŠ¸ ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyBX9EghLLhQPFUxDxGgVbe-6VjSva-r2vQ",
            authDomain: "nacm-2041e.firebaseapp.com",
            projectId: "nacm-2041e",
            storageBucket: "nacm-2041e.firebasestorage.app",
            messagingSenderId: "90299682381",
            appId: "1:90299682381:web:d39afbc694314c12765604"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // í˜„ì¬ ìœ ì € ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ìµëª… ë¡œê·¸ì¸)
        async function getUser() {
            if (auth.currentUser) return auth.currentUser;
            const { user } = await signInAnonymously(auth);
            return user;
        }

        // ğŸ”¹ 1) Firestoreì—ì„œ unlock ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
        async function fetchUnlocks() {
            const user = await getUser();
            const ref = doc(db, "users", user.uid, "meta", "unlocks");
            const snap = await getDoc(ref);

            if (snap.exists()) {
                const data = snap.data();
                console.log("ë¶ˆëŸ¬ì˜¨ unlock ìƒíƒœ:", data);
                if (window.applyStoredUnlocks) {
                    window.applyStoredUnlocks(data);   // ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì „ë‹¬
                }
            } else {
                // ì €ì¥ëœ ê²Œ ì—†ìœ¼ë©´ null ì „ë‹¬í•´ì„œ ê¸°ë³¸ ë Œë”ë§ë§Œ
                if (window.applyStoredUnlocks) {
                    window.applyStoredUnlocks(null);
                }
            }
        }

        // ğŸ”¹ 2) Firestoreì— unlock ìƒíƒœ ì €ì¥
        async function saveUnlockState(subjectId) {
            const user = await getUser();
            const ref = doc(db, "users", user.uid, "meta", "unlocks");
            await setDoc(ref, { [subjectId]: true }, { merge: true });
            console.log("unlock ì €ì¥ ì™„ë£Œ:", subjectId);
        }

        // ë©”ì¸ JSì—ì„œ í˜¸ì¶œí•˜ëŠ” í›… ì—°ê²°
        window.requestUnlockSync = function () {
            fetchUnlocks().catch(err => {
                console.error("unlock ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
                if (window.applyStoredUnlocks) {
                    window.applyStoredUnlocks(null);
                }
            });
        };

        window.saveUnlockState = function (subjectId) {
            saveUnlockState(subjectId).catch(err => {
                console.error("unlock ì €ì¥ ì‹¤íŒ¨:", err);
            });
        };
    </script>


    <div class="toast" id="toast"></div>
</body>

</html>